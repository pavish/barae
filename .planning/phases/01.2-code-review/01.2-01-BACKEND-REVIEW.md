# Backend Code Review: Phase 1.2

**Reviewed:** 2026-02-04
**Reviewer:** Claude (automated)
**Scope:** 14 backend TypeScript files

## Summary

The backend codebase demonstrates solid architectural patterns with proper Fastify plugin organization, centralized configuration, and appropriate security defaults from better-auth. The code follows established conventions documented in backend-patterns.md. Two security hardening opportunities identified (rate limiting, APP_SECRET validation), plus one potential performance improvement (database indexes).

## Security Review

### Critical Issues

None identified. The codebase uses better-auth which provides secure defaults for session management, CSRF protection, and password hashing.

### Important Issues

**1. Missing Rate Limiting on Auth Endpoints**
- **Location:** `backend/src/features/auth/routes.ts:11-72`
- **Issue:** The custom `/resend-verification` endpoint has no rate limiting. An attacker could spam email resend requests.
- **Impact:** Email abuse, potential for email provider rate limiting or spam classification
- **Recommendation:** Add rate limiting (e.g., 3 requests per hour per user) before Phase 2

**2. No APP_SECRET Minimum Length Validation**
- **Location:** `backend/src/config.ts:16`
- **Issue:** `APP_SECRET` is typed as `Type.String()` with no minimum length constraint
- **Impact:** A short or weak secret could weaken session token signing
- **Recommendation:** Add `Type.String({ minLength: 32 })` to enforce a strong secret

### Security Observations (Good Practices)

**better-auth Configuration** (`service.ts:9-66`)
- CSRF protection enabled via `trustedOrigins` configuration (line 65)
- Session expiry: 30 days with daily refresh - reasonable for "remember me" (lines 55-60)
- Password policy: Minimum 8 characters enforced (line 35)
- Email verification: Non-blocking with `sendOnSignUp: true` (lines 26-31)
- better-auth defaults handle httpOnly/secure cookie flags appropriately

**Error Response Handling** (`routes.ts:17-69`)
- Error messages are generic ("Not authenticated", "Invalid session", "User not found")
- No stack traces or internal details leaked to client
- Structured logging includes error details server-side only

**Fire-and-Forget Email Pattern** (`service.ts:28-30, 37-39, 41-44`)
- Prevents timing attacks by not awaiting email send
- Errors logged but don't affect response timing

**Configuration Security** (`config.ts`)
- All env vars accessed via Fastify config plugin
- TypeBox schema validation ensures type safety
- No secrets logged or exposed in responses

## Architecture Review

### Plugin Pattern Compliance

The codebase follows the established patterns from `backend-patterns.md`:

| Pattern | Status | Files |
|---------|--------|-------|
| Scoped type declarations | Compliant | All plugin files have `declare module 'fastify'` at bottom |
| Dependency declaration | Compliant | All plugins use `dependencies` array in `fp()` options |
| Feature module structure | Compliant | auth feature has index.ts, routes.ts, service.ts, handler.ts |
| Config access rules | Compliant | All config via `fastify.config.*` (except migrate.ts - see below) |
| Route versioning | Compliant | All routes at `/api/v1/auth/*` |

### Architectural Observations

**Good: Service Factory Pattern** (`service.ts`)
```typescript
export function createAuthService(fastify: FastifyInstance) {
  return betterAuth({
    database: drizzleAdapter(fastify.db.do, {...}),
    secret: fastify.config.APP_SECRET,
    ...
  })
}
```
- Receives Fastify instance to access plugins
- Avoids duplicate database connections (was previously an issue)

**Good: Handler Adapter Pattern** (`handler.ts`)
- Cleanly adapts between Fastify request/reply and better-auth's Web API
- Properly forwards headers including cookies
- Handles response body as text (avoiding JSON parse issues)

**Minor: migrate.ts Uses Direct process.env** (`migrate.ts:6-11`)
- This is acceptable as migrate.ts runs as a standalone CLI script, not within Fastify context
- Uses `max: 1` for single migration connection
- Could be improved with shared config module if more CLI scripts are added

### Issues Found

None. Architecture is sound and consistent.

## Code Quality

### TypeScript Usage

| Aspect | Status | Notes |
|--------|--------|-------|
| No `any` types | Pass | All types explicitly defined or inferred |
| Interface exports | Pass | `AuthService`, `EmailService` exported for type reuse |
| Type declarations | Pass | Fastify augmentations in each plugin file |
| Static type extraction | Pass | `Static<typeof schema>` pattern used correctly |

### Error Handling

**Database Operations** (`routes.ts:67-70`)
```typescript
} catch (err) {
  fastify.log.error({ err }, 'Failed to resend verification email')
  return reply.status(500).send({ error: 'Failed to send verification email' })
}
```
- Proper try/catch around database operations
- Structured logging with error object
- Generic error message to client

**Email Service** (`lib/email/index.ts:30-32, 47-49`)
```typescript
.catch((err) => {
  logger.error({ err, email }, '[Email] Failed to send verification email')
})
```
- Async errors caught and logged
- Fire-and-forget pattern maintained

**SMTP Connection** (`lib/email/index.ts:76-82`)
- Verifies SMTP on startup
- Falls back gracefully if connection fails

**Health Check** (`app.ts:35-44`)
- Tests database connectivity
- Returns 503 on failure with appropriate message

### Logging

| Category | Logged | Notes |
|----------|--------|-------|
| Plugin registration | Yes | "Auth feature registered", "Email service registered" |
| Auth route registration | Yes | "Auth routes registered at /api/v1/auth/*" |
| Email operations | Yes | Console mode logs, send failures |
| Database shutdown | Yes | Connection close logged |
| Errors | Yes | Structured with error object |

**No Sensitive Data in Logs:**
- Email URLs logged in console mode (acceptable for dev)
- No passwords, tokens, or secrets logged

## Performance Considerations

### Database Queries

**Potential N+1 in resend-verification** (`routes.ts:25-48`)
```typescript
const sessions = await fastify.db.do.select(...).from(schema.session)...
const users = await fastify.db.do.select(...).from(schema.user)...
```
- Two separate queries where one join would suffice
- **Impact:** Minimal - only affects single endpoint, single record lookups
- **Recommendation:** Consider joining in single query for cleaner code

### Connection Management

**Single Connection Pattern** (`db/index.ts:7-14`)
```typescript
const client = postgres({
  host: fastify.config.POSTGRES_HOST,
  ...
})
```
- Uses postgres.js with default connection handling
- No explicit pool configuration
- postgres.js handles connection pooling internally (default 10 connections)
- Graceful shutdown closes connection properly

### Missing Database Indexes

**Schema** (`db/schema/auth.ts`)
- `session.userId` - No index, used in foreign key lookup
- `account.userId` - No index, used in foreign key lookup

**Impact:** May affect query performance with large user counts
**Recommendation:** Add indexes as data grows

## Recommendations

### Immediate (Before Phase 2)

| # | Item | Severity | Effort |
|---|------|----------|--------|
| 1 | Add rate limiting to `/resend-verification` endpoint | Important | Low |
| 2 | Add `minLength: 32` to APP_SECRET validation | Important | Trivial |

### Future (Technical Debt)

| # | Item | Severity | Effort |
|---|------|----------|--------|
| 3 | Add indexes on session.userId and account.userId | Minor | Trivial |
| 4 | Combine session+user lookup in resend-verification to single query | Minor | Low |
| 5 | Create shared config module for CLI tools (migrate.ts) | Minor | Low |

## Files Reviewed

| # | File | Lines | Notes |
|---|------|-------|-------|
| 1 | `backend/src/features/auth/service.ts` | 67 | better-auth configuration, security settings |
| 2 | `backend/src/features/auth/routes.ts` | 79 | Custom resend endpoint, catch-all handler |
| 3 | `backend/src/features/auth/handler.ts` | 42 | Fastify-to-WebAPI adapter |
| 4 | `backend/src/features/auth/index.ts` | 24 | Plugin registration, type declaration |
| 5 | `backend/src/config.ts` | 43 | Environment validation schema |
| 6 | `backend/src/db/index.ts` | 40 | Database plugin, connection management |
| 7 | `backend/src/db/schema/auth.ts` | 51 | Drizzle table definitions |
| 8 | `backend/src/db/schema/index.ts` | 1 | Schema re-exports |
| 9 | `backend/src/db/migrate.ts` | 23 | CLI migration script |
| 10 | `backend/src/lib/email/index.ts` | 99 | Email service plugin |
| 11 | `backend/src/lib/email/templates.ts` | 57 | Email HTML templates |
| 12 | `backend/src/app.ts` | 47 | App factory, plugin registration |
| 13 | `backend/src/index.ts` | 31 | Server entry point, graceful shutdown |
| 14 | `.planning/codebase/backend-patterns.md` | 165 | Reference: established patterns |

**Total Lines Reviewed:** ~619 lines of backend TypeScript code
