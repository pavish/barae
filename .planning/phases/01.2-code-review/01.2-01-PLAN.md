---
phase: 01.2-code-review
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/01.2-code-review/01.2-01-BACKEND-REVIEW.md
autonomous: true

must_haves:
  truths:
    - "Backend code has been reviewed for security vulnerabilities"
    - "Authentication configuration (better-auth) is properly secured"
    - "Plugin architecture follows established patterns"
    - "All security concerns are documented with severity levels"
  artifacts:
    - path: ".planning/phases/01.2-code-review/01.2-01-BACKEND-REVIEW.md"
      provides: "Backend security and architecture review findings"
      contains: "## Security Review"
  key_links:
    - from: "backend/src/features/auth/service.ts"
      to: "better-auth config"
      via: "security settings verification"
      pattern: "CSRF|cookie|session"
---

<objective>
Review all backend source code for security vulnerabilities, architecture consistency, and code quality issues.

Purpose: Ensure the authentication foundation is secure and patterns are sound before building more features.
Output: Detailed review document (01.2-01-BACKEND-REVIEW.md) with categorized findings.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.2-code-review/01.2-RESEARCH.md
@.planning/codebase/backend-patterns.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Security Audit of Backend Auth Code</name>
  <files>
    backend/src/features/auth/service.ts
    backend/src/features/auth/routes.ts
    backend/src/features/auth/handler.ts
    backend/src/features/auth/index.ts
    backend/src/config.ts
  </files>
  <action>
Review all auth-related backend files with focus on security:

1. **better-auth Configuration** (service.ts):
   - Check CSRF protection is enabled and trustedOrigins configured correctly
   - Verify session cookie settings (httpOnly, secure, sameSite)
   - Check email verification settings match expected behavior
   - Verify password hashing configuration (should use argon2/bcrypt by default)
   - Check session expiration settings are reasonable

2. **Routes & Handlers** (routes.ts, handler.ts):
   - Check for input validation on all endpoints
   - Verify error responses don't leak sensitive information
   - Check rate limiting considerations (document if missing)
   - Verify CORS is properly configured

3. **Config Security** (config.ts):
   - Verify no secrets logged or exposed
   - Check APP_SECRET validation (minimum length?)
   - Verify sensitive env vars are properly typed

4. **Plugin Registration** (index.ts):
   - Verify dependency chain is correct
   - Check for proper error handling in plugin setup

Document findings in categories:
- Critical (security vulnerabilities)
- Important (architectural issues)
- Minor (style/convention)
- Observations (good patterns worth noting)
  </action>
  <verify>
All 5 auth-related backend files have been read and analyzed. Findings documented with specific file:line references where applicable.
  </verify>
  <done>
Security audit complete with all better-auth configuration, route handlers, and config access patterns reviewed and documented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Database & Infrastructure Review</name>
  <files>
    backend/src/db/index.ts
    backend/src/db/schema/auth.ts
    backend/src/db/schema/index.ts
    backend/src/db/migrate.ts
    backend/src/lib/email/index.ts
    backend/src/lib/email/templates.ts
    backend/src/app.ts
    backend/src/index.ts
  </files>
  <action>
Review database, email, and infrastructure code:

1. **Database Plugin** (db/index.ts):
   - Check connection pooling configuration
   - Verify single connection pattern is maintained
   - Check for proper error handling on connection failure
   - Verify no SQL injection vectors

2. **Schema Design** (db/schema/auth.ts):
   - Check table definitions for proper constraints
   - Verify indexes exist for commonly queried fields
   - Check timestamp handling (createdAt/updatedAt)
   - Verify foreign key relationships if any

3. **Migration System** (db/migrate.ts):
   - Check for proper error handling
   - Verify migration runs safely (idempotent?)

4. **Email Service** (lib/email/):
   - Check SMTP configuration security
   - Verify no credentials in templates
   - Check error handling on send failures
   - Verify fire-and-forget pattern is safe

5. **App Bootstrap** (app.ts, index.ts):
   - Verify plugin registration order
   - Check graceful shutdown handling
   - Check health endpoint implementation
   - Verify no sensitive data in responses

Append findings to the review document.
  </action>
  <verify>
All 8 infrastructure files reviewed. Database patterns, email service, and app bootstrap documented.
  </verify>
  <done>
Infrastructure review complete with connection management, schema design, and bootstrap patterns all analyzed and findings added to review document.
  </done>
</task>

<task type="auto">
  <name>Task 3: Write Backend Review Document</name>
  <files>.planning/phases/01.2-code-review/01.2-01-BACKEND-REVIEW.md</files>
  <action>
Create the backend review document with all findings organized:

```markdown
# Backend Code Review: Phase 1.2

**Reviewed:** {date}
**Reviewer:** Claude (automated)
**Scope:** 14 backend TypeScript files

## Summary

{2-3 sentence overview of backend code quality}

## Security Review

### Critical Issues
{List any security vulnerabilities found, or "None identified"}

### Security Observations
{Document better-auth config, cookie settings, CSRF protection status}

## Architecture Review

### Plugin Pattern Compliance
{How well does code follow established patterns?}

### Issues Found
{Any architectural problems}

### Good Patterns
{Document patterns that work well}

## Code Quality

### TypeScript Usage
{Any `any` types, missing types, etc.}

### Error Handling
{How errors are handled across the codebase}

### Logging
{What gets logged, any sensitive data concerns}

## Performance Considerations

### Database Queries
{Any N+1 or inefficient patterns}

### Connection Management
{How connections are handled}

## Recommendations

### Immediate (Before Phase 2)
{Critical fixes needed}

### Future (Technical Debt)
{Things to address eventually}

## Files Reviewed

{List all 14 files with brief notes}
```
  </action>
  <verify>
File `.planning/phases/01.2-code-review/01.2-01-BACKEND-REVIEW.md` exists and contains:
- Summary section
- Security Review section with findings
- Architecture Review section
- Code Quality section
- Recommendations section
- List of all 14 reviewed files
  </verify>
  <done>
Backend review document created with comprehensive findings organized by category, specific file references, and actionable recommendations.
  </done>
</task>

</tasks>

<verification>
- All 14 backend source files have been read and analyzed
- Review document exists at `.planning/phases/01.2-code-review/01.2-01-BACKEND-REVIEW.md`
- Security concerns are documented with severity levels
- Architecture patterns are evaluated against established conventions
- Recommendations are categorized by priority
</verification>

<success_criteria>
1. Every backend file has been reviewed (14 files)
2. Security audit covers better-auth config, session handling, input validation
3. Architecture review checks plugin patterns against backend-patterns.md
4. All findings documented with specific file:line references
5. Recommendations split into immediate vs future items
</success_criteria>

<output>
After completion, create `.planning/phases/01.2-code-review/01.2-01-SUMMARY.md`
</output>
