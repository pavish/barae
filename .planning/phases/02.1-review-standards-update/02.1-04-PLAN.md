---
phase: 02.1-review-standards-update
plan: 04
type: execute
wave: 3
depends_on: [02.1-03]
files_modified:
  - .planning/codebase/STANDARDS.md
  - .planning/codebase/backend.md
  - .planning/STATE.md
autonomous: false

must_haves:
  truths:
    - "Standards documentation accurately reflects the actual codebase after all refactoring"
    - "STATE.md is updated with Phase 2.1 decisions and updated config pattern"
    - "The dev stack starts and all auth endpoints function correctly"
    - "No stale references to old patterns remain in standards docs"
  artifacts:
    - path: ".planning/codebase/STANDARDS.md"
      provides: "Updated overview reflecting post-refactor patterns"
    - path: ".planning/STATE.md"
      provides: "Updated project state with Phase 2.1 context"
  key_links:
    - from: ".planning/codebase/STANDARDS.md"
      to: "backend/src/plugins/config.ts"
      via: "Documents the config pattern that exists in code"
      pattern: "@fastify/env"
---

<objective>
Sync standards documentation with the actual codebase after all refactoring, update project state, and verify the full dev stack works end-to-end.

Purpose: After Plans 01-03, the codebase has been significantly refactored but the standards docs written in Plan 01 described the TARGET state. This plan ensures docs match ACTUAL state, captures any adjustments made during implementation, and includes a human verification that the dev stack works.

Output: Accurate standards docs, updated STATE.md, verified working dev stack
</objective>

<execution_context>
@/Users/pavish/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pavish/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/STANDARDS.md
@.planning/codebase/backend.md
@.planning/phases/02.1-review-standards-update/02.1-01-SUMMARY.md
@.planning/phases/02.1-review-standards-update/02.1-02-SUMMARY.md
@.planning/phases/02.1-review-standards-update/02.1-03-SUMMARY.md

# Actual source files to verify against:
@backend/src/plugins/config.ts
@backend/src/app.ts
@backend/src/index.ts
@backend/src/db/client.ts
@backend/src/db/index.ts
@backend/src/auth/index.ts
@backend/src/auth/email.ts
@backend/src/routes/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sync standards docs with actual post-refactor codebase and update STATE.md</name>
  <files>
    .planning/codebase/STANDARDS.md
    .planning/codebase/backend.md
    .planning/STATE.md
  </files>
  <action>
    **Read all refactored source files** and compare against standards docs written in Plan 01.

    **Review and fix `.planning/codebase/STANDARDS.md`:**
    - Verify the Backend Stack section accurately describes:
      - Config via `@fastify/env` plugin (NOT standalone module)
      - Plugin registration order: config -> db -> auth -> auth-routes
      - close-with-grace for shutdown
    - Verify Priority Rule #1 ("No process.env outside config") is still accurate:
      - The rule should be updated: "No process.env outside config plugin" with exception for `process.env.NODE_ENV` in logger bootstrap (app.ts) + existing exceptions for drizzle.config.ts and scripts/migrate.ts
    - Check for any patterns that changed during implementation

    **Review and fix `.planning/codebase/backend.md`:**
    - Verify all code examples match the actual implementation
    - Verify the plugin architecture section matches the actual registration order
    - Verify config access patterns match (`fastify.config.FIELD_NAME` with flat env var names)
    - If the auth module structure changed from what was planned (e.g., different type declarations), update the docs
    - Verify the email error handling pattern matches what was implemented

    **Update `.planning/STATE.md`:**
    - Update "Current Position" to reflect Phase 2.1 in progress (plan 4 of 4)
    - Update "Current focus" line
    - Add Phase 2.1 decisions to Accumulated Context > Decisions:
      - [02.1]: Config via @fastify/env plugin, replacing standalone config.ts
      - [02.1]: All initialization happens inside Fastify plugin lifecycle (db, auth, email)
      - [02.1]: close-with-grace for graceful shutdown
      - [02.1]: Email errors logged, not silently swallowed
      - [02.1]: process.env.NODE_ENV read directly for logger bootstrap (single exception beyond config plugin)
      - [02.1]: Migration naming convention enforced: NNNN_descriptive_name
      - [02.1]: eslint-plugin-prettier removed, only eslint-config-prettier used
    - Update the old decision "[01-01]: Config is a standalone module, not a Fastify plugin" — mark as superseded by [02.1] decision
    - Remove or update any Pending Todos that were resolved
    - Add the "review after every phase" convention to Roadmap Evolution
  </action>
  <verify>
    - `grep "@fastify/env" .planning/codebase/STANDARDS.md` returns a match
    - `grep "standalone module" .planning/codebase/STANDARDS.md` returns NO match (old pattern removed)
    - `grep "02.1" .planning/STATE.md` shows new decisions
    - Standards docs do not reference `config.ts` as the config approach
    - No stale references to old patterns in any standards doc
  </verify>
  <done>
    All 7 standards docs verified against actual source files with discrepancies corrected. STATE.md contains Phase 2.1 decisions section. grep searches for 'config.ts' (as config approach), 'standalone module' (old config pattern), and 'process.on.*SIG' (old shutdown pattern) in standards docs return no inappropriate matches.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Phase 2.1 complete: all code reviewed and fixed, standards documentation created and synced.

    **Changes made:**
    1. Standards docs created in `.planning/codebase/` (backend.md, frontend.md, typescript.md, docker.md, dependencies.md, migrations.md)
    2. CLAUDE.md created at project root
    3. Unused backend dependencies removed (autoload, cookie, error, rate-limit, octokit/*, drizzle-typebox, fastify-raw-body, drizzle-seed, eslint-plugin-prettier)
    4. Migration renamed from `0000_orange_bloodaxe.sql` to `0000_create_auth_tables.sql`
    5. config.ts replaced with @fastify/env plugin at `src/plugins/config.ts`
    6. DB client creation moved inside Fastify db plugin (no module-level singleton)
    7. Auth (better-auth) instance creation moved inside Fastify auth plugin
    8. Email transport creation moved inside auth plugin (factory pattern)
    9. `void sendEmail()` fire-and-forget replaced with try/catch + error logging
    10. Manual `process.on` shutdown replaced with `close-with-grace`
  </what-built>
  <how-to-verify>
    1. Start the dev stack: `docker compose -f compose.dev.yml up --build`
    2. Wait for all services to be healthy
    3. Test health check: `curl http://localhost:8100/api/health` — should return `{"status":"ok","timestamp":"..."}`
    4. Test auth signup: `curl -X POST http://localhost:8100/api/auth/sign-up/email -H 'Content-Type: application/json' -d '{"email":"test@test.com","password":"testpassword123","name":"Test User"}'` — should return 200 with user data
    5. Check Mailpit at http://localhost:8025 — verification email should appear
    6. Review CLAUDE.md at project root — should be concise and reference `.planning/codebase/`
    7. Spot-check one standards doc (e.g., `backend.md`) — should be prescriptive and match actual code patterns
    8. Verify `docker compose -f compose.dev.yml down` triggers graceful shutdown messages in backend logs
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Standards docs in `.planning/codebase/` match the actual codebase (no stale references)
2. STATE.md reflects all Phase 2.1 decisions
3. Dev stack starts and all auth endpoints function correctly
4. Graceful shutdown works (visible in logs on docker compose down)
5. Human has verified the full flow
</verification>

<success_criteria>
- Standards documentation is accurate and reflects the actual post-refactor codebase
- STATE.md is updated with all Phase 2.1 context
- The dev stack passes human verification (health, auth signup, email delivery, graceful shutdown)
- User approves the checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-review-standards-update/02.1-04-SUMMARY.md`
</output>
