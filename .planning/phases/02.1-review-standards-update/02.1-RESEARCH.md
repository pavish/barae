# Phase 2.1: Review & Standards Update - Research

**Researched:** 2026-02-06
**Domain:** Code review, standards documentation, dependency audit
**Confidence:** HIGH

## Summary

This phase is a quality audit and documentation phase, not a feature-building phase. The codebase is small (~16 source files across backend and frontend) but has several concrete issues to address: unused dependencies, a migration with a random name, a hand-rolled config module that should use `@fastify/env`, `eslint-plugin-prettier` which is considered an anti-pattern, manual graceful shutdown code that should use `close-with-grace`, and missing standards documentation. The approach (standards first, review second, fix everything) is well-defined by user decisions.

The primary technology domain is the existing Fastify + React + Docker stack already in the codebase. Research focused on understanding what skills/patterns apply as review lenses, identifying concrete issues in the current code, and evaluating the `@fastify/env` vs custom config.ts question raised in the CONTEXT.md.

**Primary recommendation:** Replace `config.ts` with `@fastify/env` (official Fastify plugin wrapping `env-schema`), remove `eslint-plugin-prettier` from both packages, rename the migration file, clean up unused dependencies, and produce comprehensive standards docs in `.planning/codebase/`.

<user_constraints>
## User Constraints (from CONTEXT.md)

### Locked Decisions

**Approach: Standards first, then review**
- **Step 1:** Define standards -- combine user's specific conventions + Claude's proposals (from fastify-best-practices and typescript-magician skills + codebase analysis)
- **Step 2:** Review all Phase 1 & 2 code against those standards + skills as guides
- **Step 3:** Fix everything found -- no "log for later", all issues resolved in this phase

**User's specific standards (must be included)**
- **Drizzle migrations:** Never use random names; always specify a proper descriptive name with standard number prefix
- **No `any` type:** Refer to typescript-magician skill for conditions and best practices around type safety
- **Prefer existing Fastify plugins:** Find well-maintained plugins instead of writing own implementations (e.g., `config.ts` could use `@fastify/env` or similar); consult fastify-best-practices skill and research before building custom
- **Dependency health:** Verify npm packages are well-maintained before adding them; high-level version choices (node, npm, postgres) are deferred to user
- **Per-phase discussion:** Chat with user for additional standards during each future phase's discussion

**Standards documentation**
- Claude's discretion on file/category structure in `.planning/codebase/`
- Standards docs must be followed at every code change in this project
- Add concise references to CLAUDE.md pointing to the standards docs (not full rules in CLAUDE.md)

**Review guides**
- Use **fastify-best-practices** skill as a review lens for all backend code
- Use **typescript-magician** skill as a review lens for TypeScript patterns and type safety
- Existing standards already in `.planning/STANDARDS.md` also apply

**Issue handling**
- Fix everything found during review -- no severity triage, no deferring
- Code changes + standards docs both happen in this phase

### Claude's Discretion

- File/category structure for `.planning/codebase/` standards documentation
- How to organize and reference standards from CLAUDE.md

### Deferred Ideas (OUT OF SCOPE)

- **Review phase after every phase:** User wants a process rule that a review/standards phase is inserted after every execution phase and after full milestone completion. This should be documented as a project convention during this phase and added to ROADMAP.md conventions or `.claude/` instructions.
</user_constraints>

## Standard Stack

This phase does not introduce new libraries for features. It audits existing ones and may replace/remove some.

### Core (already in project)
| Library | Version | Purpose | Status |
|---------|---------|---------|--------|
| fastify | ^5.7.0 | HTTP framework | OK -- well-maintained, current |
| better-auth | ^1.4.18 | Authentication | OK -- actively maintained |
| drizzle-orm | ^0.45.1 | ORM | OK -- actively maintained |
| postgres | ^3.4.8 | PostgreSQL driver | OK -- well-maintained |
| nodemailer | ^7.0.13 | Email sending | OK -- well-maintained |
| fastify-plugin | ^5.1.0 | Plugin wrapper | OK -- official Fastify |
| @fastify/type-provider-typebox | ^6.1.0 | Type-safe schemas | OK -- official Fastify |
| @tanstack/react-query | ^5.90.20 | Server state | OK -- well-maintained |
| react | ^19.2.0 | UI framework | OK -- current |
| tailwindcss | ^4.1.18 | Styling | OK -- current |

### To Add
| Library | Purpose | Why |
|---------|---------|-----|
| @fastify/env | ^5.x | Config validation as Fastify plugin. Official wrapper around `env-schema`. Replaces hand-rolled `config.ts` per user request and fastify-best-practices skill guidance. |
| close-with-grace | ^2.x | Graceful shutdown. Recommended by fastify-best-practices/deployment skill. Replaces manual `process.on(SIGINT/SIGTERM)` in `index.ts`. |

### To Remove (unused dependencies)
| Library | Why Remove |
|---------|-----------|
| @fastify/autoload | In `package.json` dependencies but never imported. Not needed -- routes registered manually. |
| @fastify/cookie | In `package.json` dependencies but never imported. better-auth handles cookies internally. |
| @fastify/error | In `package.json` dependencies but never imported. May be needed in future phases, but should not be pre-installed. |
| @fastify/rate-limit | In `package.json` dependencies but never imported. Future phase concern. |
| @octokit/app | In `package.json` dependencies but never imported. Phase 4 concern. |
| @octokit/rest | In `package.json` dependencies but never imported. Phase 4 concern. |
| @sinclair/typebox | In `package.json` dependencies but never imported in src/. Only indirectly used via `@fastify/type-provider-typebox`. May be needed for `@fastify/env` schema definitions. **Keep if switching to @fastify/env, otherwise remove.** |
| drizzle-typebox | In `package.json` dependencies but never imported. Future use TBD. |
| fastify-raw-body | In `package.json` dependencies but never imported. Future webhook use (Phase 4). |
| drizzle-seed | In devDependencies but never used. |
| eslint-plugin-prettier (backend) | Anti-pattern -- runs Prettier inside ESLint causing performance issues. `eslint-config-prettier` is sufficient. Backend already uses `eslint-config-prettier`. |

**Note on pre-installed future dependencies:** Several of these (octokit, rate-limit, fastify-raw-body) are needed in future phases. The user's standard "dependency health" requires verifying packages are maintained before adding them, but the corollary is: don't pre-install unused dependencies. They should be added when the phase that needs them is executed.

### Decision required
The user needs to decide whether to remove pre-installed dependencies that are needed in future phases (clean approach, re-add when needed) or keep them (saves a future install step but contradicts dependency hygiene). **Recommendation: remove them now, add them back with the phase that uses them.** This ensures each phase's dependency audit starts clean.

## Architecture Patterns

### Current Backend Structure
```
backend/src/
  auth/
    email.ts       # Email sending via nodemailer
    index.ts       # better-auth instance configuration
  db/
    schema/
      auth.ts      # Drizzle schema for user/session/account/verification
      index.ts     # Re-export barrel
    client.ts      # Standalone postgres + drizzle client
    index.ts       # Fastify plugin wrapping db client
  routes/
    auth.ts        # Fastify plugin: catch-all /auth/* -> better-auth handler
  app.ts           # Fastify instance builder
  config.ts        # Hand-rolled env validation (to be replaced)
  index.ts         # Server entry point + graceful shutdown
```

### Current Frontend Structure
```
frontend/src/
  lib/
    api.ts         # apiFetch wrapper
    auth.ts        # better-auth React client
    queryClient.ts # TanStack Query client
    utils.ts       # cn() utility from shadcn/ui
  app.tsx          # Root component with QueryClientProvider
  main.tsx         # React root entry point
  index.css        # Tailwind + shadcn/ui theme variables
```

### Pattern: Config via @fastify/env (replacing config.ts)

The fastify-best-practices skill's `configuration.md` rule recommends `env-schema` (or its Fastify wrapper `@fastify/env`) for all configuration. The current `config.ts` is a hand-rolled alternative with custom helper functions (`requireEnv`, `optionalEnv`, etc.). `@fastify/env` provides:

1. JSON Schema validation (already using TypeBox in the project)
2. Automatic type generation via TypeBox `Static`
3. Fastify instance decoration (`fastify.config`)
4. `.env` file loading support
5. Official Fastify ecosystem library, well-maintained

**Important architectural constraint:** The current `config.ts` is imported as a standalone module (not a Fastify plugin). This is a project decision documented in STATE.md: "Config is a standalone module, not a Fastify plugin -- imported directly." Switching to `@fastify/env` means config becomes a Fastify plugin, which changes the import pattern from `import { config } from './config.js'` to accessing `fastify.config` after plugin registration.

**Impact analysis of switching to @fastify/env:**
- `app.ts` -- register `@fastify/env` plugin, access via `fastify.config`
- `index.ts` -- needs config for server host/port BEFORE Fastify starts. Can use env-schema directly here (the standalone library beneath @fastify/env), or restructure to read from the registered plugin.
- `db/client.ts` -- imports config directly. Would need to receive config as parameter or access after plugin registration.
- `auth/index.ts` -- imports config directly. Same issue.
- `auth/email.ts` -- imports config directly. Same issue.
- `routes/auth.ts` -- does not import config.
- `drizzle.config.ts` -- reads `process.env` directly (exempt per standards).
- `scripts/migrate.ts` -- reads `process.env` directly (exempt per standards).

The key challenge: `db/client.ts` and `auth/index.ts` create module-level singletons that need config at import time, before Fastify is ready. Switching to `@fastify/env` requires restructuring these to be initialized inside plugins rather than at module scope. This is actually a better pattern (initialization inside Fastify lifecycle = testable, configurable), but it is a meaningful refactor.

**Recommendation:** Use `@fastify/env` as the Fastify plugin for config. Restructure `db/client.ts` and `auth/index.ts` to accept config as parameters rather than importing the module singleton. This aligns with Fastify's plugin architecture and makes the code more testable.

### Pattern: Graceful Shutdown with close-with-grace

The fastify-best-practices skill's `deployment.md` rule recommends `close-with-grace` over manual `process.on` signal handlers. The current `index.ts` has:

```typescript
process.on('SIGINT', () => gracefulShutdown('SIGINT'))
process.on('SIGTERM', () => gracefulShutdown('SIGTERM'))
```

Replace with:
```typescript
import closeWithGrace from 'close-with-grace'

closeWithGrace({ delay: 10000 }, async ({ signal, err }) => {
  if (err) app.log.error({ err }, 'Closing due to error')
  else app.log.info({ signal }, 'Closing due to signal')
  await app.close()
})
```

### Anti-Patterns Found in Current Code

1. **Module-level singletons for db and auth** -- `db/client.ts` and `auth/index.ts` create instances at import time. This makes testing difficult and couples to the config module. Better: create inside Fastify plugins.

2. **`eslint-plugin-prettier` in backend** -- Runs Prettier as an ESLint rule. The recommended approach is `eslint-config-prettier` only (already present), with Prettier run separately. The Prettier project itself recommends against `eslint-plugin-prettier`.

3. **Health check in `app.ts` not using Fastify patterns** -- The health check is defined inline in `app.ts` rather than as a separate plugin or route module. For a small app this is acceptable, but as routes grow it should be extracted. Minor issue.

4. **`void sendEmail(...)` in auth/index.ts** -- Fire-and-forget email sending with `void`. If the email fails, the user never knows. Should at minimum log errors. The `void` pattern silently swallows the promise rejection.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Env variable validation | Custom `requireEnv`/`optionalEnv` helpers | `@fastify/env` (wraps `env-schema`) | Schema validation, type safety, Fastify integration, maintained by Fastify team |
| Graceful shutdown | Manual `process.on` signal handlers | `close-with-grace` | Handles edge cases (delay, error shutdown), recommended by Fastify |
| ESLint+Prettier integration | `eslint-plugin-prettier` | Run Prettier separately, use `eslint-config-prettier` only | Performance, correctness, recommended by tool maintainers |

## Common Pitfalls

### Pitfall 1: Config Refactor Breaking Module-Level Imports
**What goes wrong:** Switching from `import { config } from './config.js'` to `fastify.config` breaks `db/client.ts` and `auth/index.ts` which create instances at module import time.
**Why it happens:** These modules use top-level initialization that runs before Fastify plugins are registered.
**How to avoid:** Restructure db client and auth instance creation to happen inside their respective Fastify plugins, receiving config as input. The db plugin already exists (`db/index.ts`); move client creation there. Auth needs a similar plugin wrapper.
**Warning signs:** Runtime errors about undefined config properties.

### Pitfall 2: Migration Rename Breaking Existing Databases
**What goes wrong:** Renaming `0000_orange_bloodaxe.sql` to `0000_create_auth_tables.sql` would break the migration journal tracking, causing Drizzle to try to re-run the migration on existing databases.
**Why it happens:** Drizzle tracks migrations by filename in `meta/_journal.json`. Renaming the file without updating the journal causes a mismatch.
**How to avoid:** Must update BOTH the filename AND the `tag` field in `meta/_journal.json`. OR create a convention that applies only to future migrations (leaving the existing one as-is). **Recommendation:** Rename both the file and journal entry since this is early in development and no production databases exist yet.
**Warning signs:** Migration errors about "already applied" or "missing migration".

### Pitfall 3: Removing Dependencies That `better-auth` Needs Internally
**What goes wrong:** Removing `@fastify/cookie` thinking it's unused, when `better-auth` might depend on it being available.
**Why it happens:** Better-auth handles cookies internally through its own mechanism (Web API headers), not through `@fastify/cookie`. But it's worth verifying.
**How to avoid:** Check `better-auth`'s peer dependencies before removing any `@fastify/*` packages. Verify the auth flow still works after removal.
**Warning signs:** Cookie-related auth failures after dependency removal.

### Pitfall 4: Standards Docs Becoming Stale
**What goes wrong:** Standards docs are written once and never updated, becoming inaccurate over time.
**Why it happens:** No enforcement mechanism.
**How to avoid:** Add references in CLAUDE.md that point to standards docs. Include a convention that every phase review checks standards docs for accuracy. The user's "per-phase discussion" standard already addresses this for future phases.
**Warning signs:** Code that contradicts documented standards.

## Code Examples

### @fastify/env Plugin Registration
```typescript
// Source: fastify-best-practices/rules/configuration.md + @fastify/env docs
import fp from 'fastify-plugin'
import fastifyEnv from '@fastify/env'
import { Type, type Static } from '@sinclair/typebox'

const schema = Type.Object({
  SERVER_HOST: Type.String({ default: '0.0.0.0' }),
  SERVER_PORT: Type.Number({ default: 3000 }),
  NODE_ENV: Type.String({ default: 'development' }),
  POSTGRES_HOST: Type.String(),
  POSTGRES_PORT: Type.Number(),
  POSTGRES_DB: Type.String(),
  POSTGRES_USER: Type.String(),
  POSTGRES_PASSWORD: Type.String(),
  APP_SECRET: Type.String({ minLength: 32 }),
  AUTH_BASE_URL: Type.String(),
  SMTP_HOST: Type.String({ default: '' }),
  SMTP_PORT: Type.Number({ default: 587 }),
  SMTP_USER: Type.String({ default: '' }),
  SMTP_PASSWORD: Type.String({ default: '' }),
  SMTP_SECURE: Type.Boolean({ default: false }),
  EMAIL_FROM: Type.String({ default: 'Barae <noreply@barae.app>' }),
})

type Config = Static<typeof schema>

declare module 'fastify' {
  interface FastifyInstance {
    config: Config
  }
}

export default fp(async function configPlugin(fastify) {
  await fastify.register(fastifyEnv, { schema, dotenv: true })
}, { name: 'config' })
```

### Drizzle Migration Naming Convention
```bash
# Standard: NNNN_descriptive_name.sql
# Good:
npx drizzle-kit generate --name 0000_create_auth_tables
npx drizzle-kit generate --name 0001_add_github_accounts

# Bad (random Drizzle default names):
# 0000_orange_bloodaxe.sql
# 0001_fancy_warlock.sql
```

### close-with-grace Shutdown
```typescript
// Source: fastify-best-practices/rules/deployment.md
import closeWithGrace from 'close-with-grace'

closeWithGrace({ delay: 10000 }, async ({ signal, err }) => {
  if (err) {
    app.log.error({ err }, 'Server closing due to error')
  } else {
    app.log.info({ signal }, 'Server closing due to signal')
  }
  await app.close()
})
```

## Identified Issues (Pre-Review Findings)

These issues were found during research by reading all Phase 1 & 2 source code. The planner should incorporate these into review tasks.

### Backend Issues

| # | File | Issue | Standard Violated | Fix |
|---|------|-------|-------------------|-----|
| 1 | `config.ts` | Hand-rolled env validation | Prefer existing Fastify plugins | Replace with `@fastify/env` |
| 2 | `index.ts` | Manual `process.on` shutdown handlers | fastify-best-practices/deployment | Use `close-with-grace` |
| 3 | `auth/index.ts` | `void sendEmail(...)` fire-and-forget | Error handling best practice | At minimum log errors; consider awaiting |
| 4 | `auth/index.ts` | Module-level singleton (depends on config import) | Fastify plugin architecture | Move initialization inside plugin |
| 5 | `db/client.ts` | Module-level singleton (depends on config import) | Fastify plugin architecture | Move initialization inside db plugin |
| 6 | `migrations/0000_orange_bloodaxe.sql` | Random migration name | User standard: descriptive names with number prefix | Rename to `0000_create_auth_tables.sql` + update journal |
| 7 | `package.json` | 8+ unused dependencies installed | Dependency health | Remove unused deps, re-add when needed |
| 8 | `package.json` | `eslint-plugin-prettier` in devDeps | Linting best practice | Remove; keep only `eslint-config-prettier` |
| 9 | `eslint.config.js` | Uses `eslint-plugin-prettier` | Linting best practice | Remove plugin import/usage |
| 10 | `app.ts` | `TypeBoxTypeProvider` imported but TypeBox schemas not used in any route | Unused code | Verify needed for `@fastify/env` integration, else remove until schemas are defined |

### Frontend Issues

| # | File | Issue | Standard Violated | Fix |
|---|------|-------|-------------------|-----|
| 11 | `package.json` | Multiple scaffolded-but-unused deps | Dependency health | Keep -- these are for Phase 3 (imminent). Document decision. |

### Infrastructure Issues

| # | File | Issue | Standard Violated | Fix |
|---|------|-------|-------------------|-----|
| 12 | `.planning/codebase/` | Only has STANDARDS.md; no detailed docs | STND-01, STND-02 | Create comprehensive standards documentation |
| 13 | CLAUDE.md | Does not exist | Convention: CLAUDE.md references standards | Create with concise references to `.planning/codebase/` docs |

## Standards Documentation Structure (Recommendation)

The `.planning/codebase/` directory should contain focused, actionable documents:

```
.planning/codebase/
  STANDARDS.md           # Already exists -- priority rules, project structure, naming
  backend.md             # Backend-specific: Fastify patterns, plugin conventions, config, db
  frontend.md            # Frontend-specific: React patterns, component conventions, state
  typescript.md          # TypeScript rules: strict mode, no-any policy, type patterns
  docker.md              # Docker & infrastructure: compose patterns, Caddy config
  dependencies.md        # Dependency policy: health checks, when to add/remove
  migrations.md          # Database migrations: naming, generation, running
```

Each file should be:
- **Prescriptive:** "Do X" not "Consider X"
- **Concrete:** Include actual code patterns from the codebase
- **Enforceable:** Every standard is something a reviewer can check for

CLAUDE.md at project root should contain:
- One-line summary of project
- Pointer to `.planning/codebase/STANDARDS.md` as the authority
- List of skills and when to load them
- Critical rules (the Priority Rules from STANDARDS.md)

## State of the Art

| Old Approach | Current Approach | Impact |
|--------------|------------------|--------|
| eslint-plugin-prettier | eslint-config-prettier + separate Prettier | Better performance, fewer conflicts |
| Manual env validation | @fastify/env (env-schema) | Schema validation, TypeBox types, Fastify integration |
| Manual process.on shutdown | close-with-grace | Better edge case handling, delay support |
| Module-level singletons | Plugin-scoped initialization | Better testability, Fastify lifecycle alignment |

## Open Questions

1. **Frontend dependency cleanup scope:**
   Frontend has many unused dependencies (react-router-dom, zustand, zod, react-hook-form, etc.) that are scaffolded for Phase 3 which is the next execution phase. Removing and re-adding seems wasteful. **Recommendation:** Keep them but document the decision as intentional scaffolding.

2. **Config refactor depth:**
   Switching to `@fastify/env` requires restructuring how `db/client.ts` and `auth/index.ts` receive config. This is the right architectural direction but is the most complex change in this phase. The planner needs to sequence this carefully: config plugin first, then db restructure, then auth restructure.

3. **CLAUDE.md creation vs STANDARDS.md:**
   Currently there is no CLAUDE.md at project root. The `.planning/codebase/STANDARDS.md` serves as the de-facto standards doc. The CONTEXT.md says "Add concise references to CLAUDE.md pointing to the standards docs." The user likely wants CLAUDE.md created as a project-root entry point. The `.gitignore` currently includes `.claude` but not CLAUDE.md specifically, so CLAUDE.md should be tracked in git.

## Sources

### Primary (HIGH confidence)
- Codebase analysis: all 16 source files read directly
- fastify-best-practices skill: `configuration.md`, `plugins.md`, `routes.md`, `error-handling.md`, `typescript.md`, `schemas.md`, `database.md`, `logging.md`, `deployment.md`
- typescript-magician skill: `SKILL.md` (no-any philosophy, type safety patterns)
- better-auth-best-practices skill: `SKILL.md` (session config, plugin config, gotchas)

### Secondary (MEDIUM confidence)
- [@fastify/env GitHub](https://github.com/fastify/fastify-env) -- verified as wrapper around env-schema, Fastify 5 compatible
- [env-schema GitHub](https://github.com/fastify/env-schema) -- standalone validation, TypeBox support confirmed
- [eslint-plugin-prettier guidance](https://github.com/prettier/eslint-plugin-prettier) -- maintainers recommend against use
- [Prettier integration docs](https://prettier.io/docs/integrating-with-linters) -- official recommendation for separate tools

### Tertiary (LOW confidence)
- close-with-grace version/API -- referenced from skill docs but not verified against npm. LOW confidence on exact API.

## Metadata

**Confidence breakdown:**
- Identified issues: HIGH -- all found by reading actual source code
- Config replacement (@fastify/env): HIGH -- verified against official docs and Fastify skill
- Standards doc structure: HIGH -- based on project patterns and user requirements
- Dependency audit: HIGH -- verified every import in every source file
- eslint-plugin-prettier removal: MEDIUM -- well-documented recommendation but verify no side effects

**Research date:** 2026-02-06
**Valid until:** 2026-03-06 (stable domain, no fast-moving concerns)
