---
phase: 02.1-review-standards-update
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/codebase/STANDARDS.md
  - .planning/codebase/backend.md
  - .planning/codebase/frontend.md
  - .planning/codebase/typescript.md
  - .planning/codebase/docker.md
  - .planning/codebase/dependencies.md
  - .planning/codebase/migrations.md
  - CLAUDE.md
autonomous: true

must_haves:
  truths:
    - "`.planning/codebase/` contains prescriptive, enforceable standards documents covering all established patterns"
    - "CLAUDE.md exists at project root with concise references to standards docs"
    - "Standards cover backend (Fastify plugins, config, db, auth), frontend (React, state, components), TypeScript (strict mode, no-any), Docker (compose, Caddy), dependencies (health, audit), and migrations (naming)"
  artifacts:
    - path: ".planning/codebase/backend.md"
      provides: "Backend standards: Fastify plugin patterns, route conventions, config, db, auth, error handling, logging"
    - path: ".planning/codebase/frontend.md"
      provides: "Frontend standards: React patterns, component conventions, state management, API calls"
    - path: ".planning/codebase/typescript.md"
      provides: "TypeScript rules: strict mode settings, no-any policy, type patterns, import aliases"
    - path: ".planning/codebase/docker.md"
      provides: "Docker standards: compose patterns, Caddy config, Dockerfile conventions, service naming"
    - path: ".planning/codebase/dependencies.md"
      provides: "Dependency policy: health checks, when to add/remove, audit process"
    - path: ".planning/codebase/migrations.md"
      provides: "Migration standards: naming convention, generation, journal management"
    - path: "CLAUDE.md"
      provides: "Project root entry point referencing standards docs and listing skills"
  key_links:
    - from: "CLAUDE.md"
      to: ".planning/codebase/STANDARDS.md"
      via: "Reference pointer"
      pattern: "\\.planning/codebase/"
---

<objective>
Create comprehensive codebase standards documentation reflecting all patterns established in Phases 1 and 2, and create CLAUDE.md as the project root entry point.

Purpose: This is Step 1 of the user's locked approach (standards first, review second, fix third). Standards must exist before code review begins so reviewers know what to check for. These documents become enforced project rules for all future code changes.

Output: 7 standards documents in `.planning/codebase/` + CLAUDE.md at project root
</objective>

<execution_context>
@/Users/pavish/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pavish/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/STANDARDS.md
@.planning/phases/02.1-review-standards-update/02.1-RESEARCH.md
@.planning/phases/02.1-review-standards-update/02.1-CONTEXT.md

# Skills to load as review lenses (load each when writing its relevant doc)
# /fastify-best-practices — when writing backend.md
# /better-auth-best-practices — when writing backend.md auth section
# /typescript-magician — when writing typescript.md

# Read all source files to extract actual patterns:
@backend/src/app.ts
@backend/src/config.ts
@backend/src/index.ts
@backend/src/db/client.ts
@backend/src/db/index.ts
@backend/src/db/schema/auth.ts
@backend/src/db/schema/index.ts
@backend/src/auth/index.ts
@backend/src/auth/email.ts
@backend/src/routes/auth.ts
@frontend/src/app.tsx
@frontend/src/main.tsx
@frontend/src/lib/api.ts
@frontend/src/lib/auth.ts
@frontend/src/lib/queryClient.ts
@frontend/src/lib/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create backend, frontend, typescript, docker, dependencies, and migrations standards docs</name>
  <files>
    .planning/codebase/backend.md
    .planning/codebase/frontend.md
    .planning/codebase/typescript.md
    .planning/codebase/docker.md
    .planning/codebase/dependencies.md
    .planning/codebase/migrations.md
  </files>
  <action>
    Create 6 focused standards documents in `.planning/codebase/`. Each document must be:
    - **Prescriptive:** "Do X" not "Consider X"
    - **Concrete:** Include actual code patterns from the codebase (current or target patterns from research)
    - **Enforceable:** Every standard is something a reviewer can check for

    **Load skills as review lenses before writing:**
    - Load `/fastify-best-practices` skill before writing `backend.md`
    - Load `/typescript-magician` skill before writing `typescript.md`
    - Do NOT load all skills at once

    **backend.md** must cover:
    - Fastify plugin architecture (use `fastify-plugin` for shared state, avoid module-level singletons)
    - Configuration: use `@fastify/env` with TypeBox schema (NOT hand-rolled helpers). Config accessed via `fastify.config` after plugin registration
    - Database: Drizzle ORM via Fastify plugin. Client created inside plugin, not at module scope
    - Auth: better-auth instance created inside Fastify plugin lifecycle, not at module scope
    - Routes: feature-based plugins (`routes/auth.ts`, `routes/github.ts`), registered in `app.ts`
    - Error handling: log errors, never silently swallow promise rejections (no `void asyncFn()`)
    - Graceful shutdown: use `close-with-grace` (NOT manual `process.on` handlers)
    - Logging: pino-pretty in dev, JSON in prod, configured via Fastify logger options
    - Health check: `/health` endpoint checking db connectivity
    - Prefer official Fastify plugins over hand-rolled implementations
    - Caddy handles CORS -- no `@fastify/cors`
    - API versioning: all routes use `/v1/` prefix

    **frontend.md** must cover:
    - React 19 + TypeScript strict mode
    - Component patterns: shadcn/ui (new-york style, neutral base, CSS variables)
    - State: TanStack Query for server state (5min staleTime, 1 retry), Zustand for client state
    - API calls: `apiFetch` wrapper using relative `/api` path, no env variables
    - Auth client: better-auth React client with relative `/api` baseURL
    - Routing: React Router (future, currently scaffolded)
    - Styling: Tailwind CSS v4 + shadcn/ui component system
    - No frontend env variables -- impossible in production static builds
    - Import alias: `@/` maps to `src/`

    **typescript.md** must cover (load `/typescript-magician` skill first):
    - Very strict mode: `strict: true` + `noUncheckedIndexedAccess` + `exactOptionalPropertyTypes`
    - No `any` type: refer to typescript-magician skill for conditions and best practices. Document when `unknown` is the right alternative, when type narrowing is required, and the rare exceptions where `any` might be acceptable (e.g., third-party type gaps with immediate narrowing)
    - ESLint: `typescript-eslint/recommended` + `eslint-config-prettier` (NO `eslint-plugin-prettier`)
    - Prettier: run separately, not through ESLint
    - Unused vars: `argsIgnorePattern: '^_'` consistent across backend and frontend
    - Import aliases: `@/` maps to `src/` in both packages
    - Module format: ESM (`"type": "module"`)

    **docker.md** must cover:
    - Everything containerized (backend, proxy, Postgres, Caddy)
    - Dockerfiles at project root (root build context), multi-stage for dev/prod
    - Three compose files: dev, prod, test
    - Container prefix: `barae-`
    - Service naming: `barae-dev-*` for dev, `barae-*` for prod, `barae-test-*` for test
    - Caddy reverse proxy: `handle_path` strips `/api/` prefix
    - Dev: HTTP on port 8100. Prod: auto-HTTPS via Let's Encrypt
    - Named volumes for DB persistence and node_modules cache
    - `depends_on` + healthcheck for startup ordering
    - Single `.env` at project root for Docker Compose

    **dependencies.md** must cover:
    - Verify npm packages are well-maintained before adding (check repo activity, download counts, last publish date)
    - Do NOT pre-install dependencies for future phases -- add them when the phase that needs them executes
    - High-level version choices (node, npm, postgres major versions) are deferred to user
    - Per-phase dependency audit: review all deps during each phase's review cycle
    - Frontend deps: keep scaffolded deps for imminent phases (Phase 3), document as intentional
    - `@sinclair/typebox` is a direct dependency (used by `@fastify/env` schema definitions)

    **migrations.md** must cover:
    - Never use random Drizzle default names. Always specify descriptive names: `npx drizzle-kit generate --name NNNN_descriptive_name`
    - Standard number prefix: `0000_`, `0001_`, etc.
    - When renaming a migration file, MUST also update the `tag` field in `meta/_journal.json`
    - `drizzle.config.ts` uses schema array (not barrel `index.ts`) due to CJS import resolution conflict
    - `drizzle.config.ts` and `scripts/migrate.ts` read `process.env` directly (exempt from config-only rule)
    - Separate migration script exists for CI/CD (runs before service deployment)
  </action>
  <verify>
    All 6 files exist in `.planning/codebase/`:
    - `ls .planning/codebase/backend.md .planning/codebase/frontend.md .planning/codebase/typescript.md .planning/codebase/docker.md .planning/codebase/dependencies.md .planning/codebase/migrations.md`
    - Each file contains prescriptive rules (grep for imperative verbs: "must", "do", "never", "always")
    - No file is shorter than 20 lines (enough substance to be useful)
  </verify>
  <done>
    Six standards documents exist covering backend, frontend, TypeScript, Docker, dependencies, and migrations. Each document contains prescriptive, enforceable rules based on actual project patterns and skill guidance.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update STANDARDS.md and create CLAUDE.md</name>
  <files>
    .planning/codebase/STANDARDS.md
    CLAUDE.md
  </files>
  <action>
    **Update `.planning/codebase/STANDARDS.md`:**
    - Keep the existing Priority Rules section (these are user-defined and must not be changed)
    - Update Backend Stack section: change "Config is a standalone module" to "Config via `@fastify/env` plugin -- accessed via `fastify.config` after registration"
    - Add a "Standards Documents" section that lists all 6 new docs and their scope
    - Add a "Project Conventions" section documenting the user's preferred practice: "The team follows a review-after-phase practice: a review/standards phase is inserted after every execution phase and after full milestone completion to maintain code quality and standards accuracy." This documents a project practice (user preference), NOT a GSD workflow enforcement — it is informational for future phase planning.
    - Remove any patterns that will be superseded by the detailed docs (avoid duplication -- STANDARDS.md is the overview, detailed docs are the reference)

    **Create `CLAUDE.md` at project root:**
    - One-line project summary: "Barae is a GitHub-integrated CMS for managing Astro-based websites, built for long-term maintenance."
    - Section: "Codebase Standards" with pointer: "All standards are in `.planning/codebase/`. The authority document is `.planning/codebase/STANDARDS.md`. Individual topic docs: backend.md, frontend.md, typescript.md, docker.md, dependencies.md, migrations.md."
    - Section: "Critical Rules" listing the Priority Rules from STANDARDS.md (duplicated here for visibility since CLAUDE.md is the first thing Claude reads)
    - Section: "Skills" with the three skills and when to load them (copied from STANDARDS.md)
    - Keep CLAUDE.md concise -- it is a pointer, not a full standards document
    - Total length: 30-50 lines maximum
  </action>
  <verify>
    - `cat CLAUDE.md` exists and references `.planning/codebase/`
    - `cat .planning/codebase/STANDARDS.md` has "Standards Documents" section
    - CLAUDE.md is under 60 lines
    - STANDARDS.md still has all 6 Priority Rules intact
  </verify>
  <done>
    STANDARDS.md updated with standards document index and review convention. CLAUDE.md exists at project root as a concise entry point referencing all standards docs.
  </done>
</task>

</tasks>

<verification>
1. All 8 files exist: 6 new docs + updated STANDARDS.md + new CLAUDE.md
2. CLAUDE.md references `.planning/codebase/` as the authority
3. STANDARDS.md Priority Rules are unchanged (user-defined, never modify)
4. Each standards doc is prescriptive and enforceable
5. No contradictions between docs (e.g., backend.md and STANDARDS.md agree on config pattern)
</verification>

<success_criteria>
- `.planning/codebase/` has 7 files (STANDARDS.md + 6 new topic docs)
- CLAUDE.md exists at project root
- Standards documents reflect the TARGET state (post-refactor patterns like @fastify/env, close-with-grace) since they will guide the code fixes in Plans 02 and 03
- The "review after every phase" practice is documented as a project convention (user preference, not workflow enforcement)
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-review-standards-update/02.1-01-SUMMARY.md`
</output>
