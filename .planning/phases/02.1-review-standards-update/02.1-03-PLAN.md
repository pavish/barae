---
phase: 02.1-review-standards-update
plan: 03
type: execute
wave: 2
depends_on: [02.1-02]
files_modified:
  - backend/package.json
  - backend/src/config.ts
  - backend/src/plugins/config.ts
  - backend/src/app.ts
  - backend/src/index.ts
  - backend/src/db/client.ts
  - backend/src/db/index.ts
  - backend/src/auth/index.ts
  - backend/src/auth/email.ts
  - backend/src/routes/auth.ts
autonomous: true

must_haves:
  truths:
    - "Config is provided via @fastify/env plugin, accessed as fastify.config after registration"
    - "Database client is created inside the Fastify db plugin, not at module scope"
    - "better-auth instance is created inside a Fastify plugin, not at module scope"
    - "Email transport is created inside the auth plugin, not at module scope"
    - "Graceful shutdown uses close-with-grace, not manual process.on handlers"
    - "Email sending errors are logged, not silently swallowed"
    - "The server starts and responds to /health correctly"
  artifacts:
    - path: "backend/src/plugins/config.ts"
      provides: "@fastify/env plugin with TypeBox schema and Fastify instance type augmentation"
      contains: "fastifyEnv"
    - path: "backend/src/app.ts"
      provides: "Fastify app builder registering config plugin first, then db and auth"
    - path: "backend/src/index.ts"
      provides: "Server entry point using close-with-grace for shutdown"
      contains: "closeWithGrace"
    - path: "backend/src/db/index.ts"
      provides: "DB plugin creating postgres+drizzle client inside plugin using fastify.config"
    - path: "backend/src/auth/index.ts"
      provides: "Auth plugin creating better-auth instance inside plugin using fastify.config"
    - path: "backend/src/auth/email.ts"
      provides: "Email module accepting config as parameter, not importing from config.ts"
  key_links:
    - from: "backend/src/app.ts"
      to: "backend/src/plugins/config.ts"
      via: "Fastify plugin registration (must be first)"
      pattern: "register.*config"
    - from: "backend/src/db/index.ts"
      to: "fastify.config"
      via: "Accessing config after plugin registration"
      pattern: "fastify\\.config"
    - from: "backend/src/auth/index.ts"
      to: "fastify.config"
      via: "Accessing config after plugin registration"
      pattern: "fastify\\.config"
    - from: "backend/src/index.ts"
      to: "close-with-grace"
      via: "Import and setup"
      pattern: "closeWithGrace"
---

<objective>
Replace hand-rolled config.ts with @fastify/env plugin, restructure db and auth modules to use plugin-scoped initialization, replace manual shutdown with close-with-grace, and fix fire-and-forget email error handling.

Purpose: This is the core architectural improvement of Phase 2.1. Moving from module-level singletons to Fastify plugin-scoped initialization aligns with Fastify's architecture, improves testability, and follows the fastify-best-practices skill guidance. This also addresses the user's locked decision to "prefer existing Fastify plugins over hand-rolled implementations."

Output: Refactored backend where all initialization happens inside the Fastify plugin lifecycle, config via @fastify/env, graceful shutdown via close-with-grace
</objective>

<execution_context>
@/Users/pavish/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pavish/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1-review-standards-update/02.1-RESEARCH.md
@.planning/phases/02.1-review-standards-update/02.1-02-SUMMARY.md

# Load skill as review lens
# /fastify-best-practices — for plugin architecture, config, deployment patterns

# Current source files to refactor:
@backend/src/config.ts
@backend/src/app.ts
@backend/src/index.ts
@backend/src/db/client.ts
@backend/src/db/index.ts
@backend/src/auth/index.ts
@backend/src/auth/email.ts
@backend/src/routes/auth.ts
@backend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install new deps, create @fastify/env config plugin, update index.ts with close-with-grace</name>
  <files>
    backend/package.json
    backend/src/plugins/config.ts
    backend/src/config.ts
    backend/src/index.ts
    backend/src/app.ts
  </files>
  <action>
    **Install new dependencies:**
    ```bash
    cd backend && npm install @fastify/env close-with-grace
    cd backend && npm install --save-dev @types/close-with-grace  # if types exist, otherwise skip
    ```
    Note: `@sinclair/typebox` should already be in dependencies (kept in Plan 02). Verify it's there.

    **Create `backend/src/plugins/config.ts`:**
    - Create the `plugins/` directory if it doesn't exist
    - Define a TypeBox schema covering all env vars currently in config.ts:
      - `SERVER_HOST` (string, default '0.0.0.0')
      - `SERVER_PORT` (number, default 3000)
      - `NODE_ENV` (string, default 'development')
      - `POSTGRES_HOST` (string, required)
      - `POSTGRES_PORT` (number, required)
      - `POSTGRES_DB` (string, required)
      - `POSTGRES_USER` (string, required)
      - `POSTGRES_PASSWORD` (string, required)
      - `APP_SECRET` (string, required, minLength 32)
      - `AUTH_BASE_URL` (string, required)
      - `SMTP_HOST` (string, default '')
      - `SMTP_PORT` (number, default 587)
      - `SMTP_USER` (string, default '')
      - `SMTP_PASSWORD` (string, default '')
      - `SMTP_SECURE` (boolean, default false)
      - `EMAIL_FROM` (string, default 'Barae <noreply@barae.app>')
    - Use `fp()` wrapper with `{ name: 'config' }`
    - Register `@fastify/env` with the schema and `dotenv: true`
    - Augment `FastifyInstance` type: `declare module 'fastify' { interface FastifyInstance { config: Config } }`
    - Export the `Config` type for use in other modules

    **IMPORTANT @fastify/env behavior:**
    - `@fastify/env` uses `env-schema` under the hood. The TypeBox schema `Type.Number()` will coerce string env vars to numbers automatically
    - `Type.Boolean()` will coerce 'true'/'false' strings to booleans
    - Required fields are those WITHOUT a `default` — if not present in env, validation fails
    - `dotenv: true` loads `.env` file from process.cwd() — but in Docker, env vars come from compose, so this is a fallback for local non-Docker development

    **Delete `backend/src/config.ts`:**
    - After creating the plugin, delete the old config.ts file entirely
    - This file will no longer be imported by anything

    **Update `backend/src/index.ts`:**
    - Remove the `import { config } from './config.js'` line
    - Replace manual `process.on('SIGINT'/'SIGTERM')` and `gracefulShutdown` function with `close-with-grace`:
    ```typescript
    import closeWithGrace from 'close-with-grace'
    import { buildApp } from './app.js'

    const app = await buildApp()

    closeWithGrace({ delay: 10000 }, async ({ signal, err }) => {
      if (err) {
        app.log.error({ err }, 'Server closing due to error')
      } else {
        app.log.info({ signal }, 'Server closing due to signal')
      }
      await app.close()
    })

    try {
      await app.listen({ host: app.config.SERVER_HOST, port: app.config.SERVER_PORT })
    } catch (err) {
      app.log.error(err)
      process.exit(1)
    }
    ```
    - Note: `app.ready()` is not needed before `app.listen()` — `listen()` calls `ready()` internally
    - Note: Access config via `app.config.SERVER_HOST` and `app.config.SERVER_PORT` (flat env var names, not nested)

    **Update `backend/src/app.ts`:**
    - Remove `import { config } from './config.js'`
    - Import and register the config plugin FIRST (before db and auth plugins):
    ```typescript
    import configPlugin from './plugins/config.js'
    ```
    - Register order: config -> db -> authRoutes
    - For the logger configuration, we need NODE_ENV before Fastify is fully ready. Two options:
      a) Read `process.env.NODE_ENV` directly for logger config only (it's a bootstrap concern)
      b) Use a two-phase init
    - **Use option (a):** Read `process.env.NODE_ENV ?? 'development'` directly in the logger config. This is acceptable because logger config is needed at Fastify instantiation time, before any plugins can run. Document this as the single exception.
    - Keep `TypeBoxTypeProvider` — it's used by `@fastify/env` for config type inference and will be used for route schemas in future phases
    - The health check accesses `app.db.do` which is set up by the db plugin — this is fine since the health check runs after all plugins are registered
  </action>
  <verify>
    - `ls backend/src/plugins/config.ts` exists
    - `ls backend/src/config.ts` does NOT exist (deleted)
    - `grep "closeWithGrace" backend/src/index.ts` returns a match
    - `grep "process.on.*SIG" backend/src/index.ts` returns NO match
    - `grep "fastifyEnv" backend/src/plugins/config.ts` returns a match
    - `grep "config" backend/src/app.ts` shows config plugin registration
    - `cd backend && npx tsc --noEmit` passes (no type errors)
  </verify>
  <done>
    @fastify/env config plugin replaces hand-rolled config.ts. close-with-grace replaces manual shutdown handlers. app.ts registers config plugin first. index.ts uses app.config for server host/port.
  </done>
</task>

<task type="auto">
  <name>Task 2: Restructure db and auth modules to plugin-scoped initialization</name>
  <files>
    backend/src/db/client.ts
    backend/src/db/index.ts
    backend/src/auth/index.ts
    backend/src/auth/email.ts
    backend/src/routes/auth.ts
  </files>
  <action>
    **Restructure `backend/src/db/client.ts` and `backend/src/db/index.ts`:**

    The current pattern: `db/client.ts` creates a module-level postgres+drizzle instance, `db/index.ts` wraps it in a Fastify plugin.

    New pattern: Move all client creation INTO the Fastify plugin (`db/index.ts`). `db/client.ts` can either be deleted or repurposed.

    **Option:** Keep `db/client.ts` as a factory function (not a singleton):
    ```typescript
    // db/client.ts — factory, not singleton
    import { drizzle } from 'drizzle-orm/postgres-js'
    import postgres from 'postgres'
    import * as dbSchema from './schema/index.js'

    export function createDbClient(config: { host: string; port: number; database: string; username: string; password: string }) {
      const client = postgres({
        host: config.host,
        port: config.port,
        database: config.database,
        username: config.username,
        password: config.password,
      })
      const db = drizzle(client, { schema: dbSchema })
      return { client, db }
    }

    export { dbSchema as schema }
    ```

    **Update `backend/src/db/index.ts`:**
    ```typescript
    import fp from 'fastify-plugin'
    import { createDbClient, schema as dbSchema } from './client.js'

    export default fp(
      async (fastify) => {
        const { client, db } = createDbClient({
          host: fastify.config.POSTGRES_HOST,
          port: fastify.config.POSTGRES_PORT,
          database: fastify.config.POSTGRES_DB,
          username: fastify.config.POSTGRES_USER,
          password: fastify.config.POSTGRES_PASSWORD,
        })

        const dbHandler = { client, schema: dbSchema, do: db }
        fastify.decorate('db', dbHandler)

        fastify.addHook('onClose', async (instance) => {
          instance.log.info('Closing database connection')
          await instance.db.client.end()
          instance.log.info('Database connection closed gracefully')
        })
      },
      { name: 'db', dependencies: ['config'] }
    )

    // Keep the type declaration
    declare module 'fastify' {
      interface FastifyInstance {
        db: { client: ReturnType<typeof import('./client.js').createDbClient>['client']; schema: typeof import('./schema/index.js'); do: ReturnType<typeof import('./client.js').createDbClient>['db'] }
      }
    }
    ```
    Note: The type declaration for `db` on FastifyInstance may need adjustment. Use a proper type derived from the factory return type. The exact approach:
    - Define the `DbHandler` type in `db/index.ts` based on what `createDbClient` returns
    - Augment FastifyInstance with that type

    Also add `dependencies: ['config']` to the plugin options so Fastify enforces registration order.

    **Restructure `backend/src/auth/email.ts`:**
    Change from module-level transporter to a factory function:
    ```typescript
    import nodemailer from 'nodemailer'

    interface EmailConfig {
      host: string
      port: number
      secure: boolean
      user: string
      password: string
      from: string
    }

    interface EmailOptions {
      to: string
      subject: string
      text: string
      html?: string
    }

    export function createEmailSender(config: EmailConfig) {
      const transporter = nodemailer.createTransport({
        host: config.host,
        port: config.port,
        secure: config.secure,
        ...(config.user ? { auth: { user: config.user, pass: config.password } } : {}),
      })

      return async function sendEmail(options: EmailOptions): Promise<void> {
        await transporter.sendMail({
          from: config.from,
          ...options,
        })
      }
    }
    ```

    **Restructure `backend/src/auth/index.ts`:**
    Change from module-level singleton to a Fastify plugin that creates the better-auth instance inside the plugin lifecycle:
    ```typescript
    import fp from 'fastify-plugin'
    import { betterAuth } from 'better-auth'
    import { drizzleAdapter } from 'better-auth/adapters/drizzle'
    import { emailOTP } from 'better-auth/plugins'
    import { createEmailSender } from './email.js'

    export default fp(
      async (fastify) => {
        const { config } = fastify

        const sendEmail = createEmailSender({
          host: config.SMTP_HOST,
          port: config.SMTP_PORT,
          secure: config.SMTP_SECURE,
          user: config.SMTP_USER,
          password: config.SMTP_PASSWORD,
          from: config.EMAIL_FROM,
        })

        const authBaseURL = `${config.AUTH_BASE_URL}/auth`

        const auth = betterAuth({
          appName: 'Barae',
          baseURL: authBaseURL,
          basePath: '/api/auth',
          secret: config.APP_SECRET,
          database: drizzleAdapter(fastify.db.do, {
            provider: 'pg',
            schema: fastify.db.schema,
          }),
          emailAndPassword: {
            enabled: true,
            requireEmailVerification: true,
            minPasswordLength: 8,
            maxPasswordLength: 128,
            autoSignIn: true,
          },
          session: {
            expiresIn: 60 * 60 * 24 * 7,
            updateAge: 60 * 60 * 24,
          },
          plugins: [
            emailOTP({
              otpLength: 6,
              expiresIn: 300,
              sendVerificationOnSignUp: true,
              sendVerificationOTP: async ({ email, otp, type }) => {
                const subjects: Record<string, string> = {
                  'email-verification': 'Verify your Barae email',
                  'forget-password': 'Reset your Barae password',
                  'sign-in': 'Your Barae sign-in code',
                }
                try {
                  await sendEmail({
                    to: email,
                    subject: subjects[type] ?? 'Your Barae verification code',
                    text: `Your verification code is: ${otp}\n\nThis code expires in 5 minutes.`,
                  })
                } catch (err) {
                  fastify.log.error({ err, email, type }, 'Failed to send verification email')
                }
              },
            }),
          ],
          trustedOrigins: [new URL(config.AUTH_BASE_URL).origin],
        })

        fastify.decorate('auth', auth)
      },
      { name: 'auth', dependencies: ['config', 'db'] }
    )

    declare module 'fastify' {
      interface FastifyInstance {
        auth: ReturnType<typeof import('better-auth').betterAuth>
      }
    }
    ```

    **KEY FIX — `void sendEmail(...)` replaced with try/catch:**
    - The old code used `void sendEmail(...)` which silently swallowed promise rejections
    - New code uses `try { await sendEmail(...) } catch (err) { fastify.log.error(...) }`
    - This ensures email failures are logged so operators can diagnose issues
    - The email send is still inside the OTP callback (not blocking the auth response), but errors are now visible

    **Update `backend/src/routes/auth.ts`:**
    - Change from importing `auth` from `../auth/index.js` to accessing `fastify.auth`:
    ```typescript
    import fp from 'fastify-plugin'

    export default fp(
      async (fastify) => {
        fastify.route({
          method: ['GET', 'POST'],
          url: '/auth/*',
          handler: async (request, reply) => {
            const url = new URL(`/api${request.url}`, `http://${request.headers.host}`)

            const headers = new Headers()
            for (const [key, value] of Object.entries(request.headers)) {
              if (value !== undefined) {
                headers.append(key, Array.isArray(value) ? value.join(', ') : value)
              }
            }

            const req = new Request(url.toString(), {
              method: request.method,
              headers,
              ...(request.body ? { body: JSON.stringify(request.body) } : {}),
            })

            const response = await fastify.auth.handler(req)

            reply.status(response.status)
            response.headers.forEach((value, key) => {
              reply.header(key, value)
            })

            const text = await response.text()
            return reply.send(text || null)
          },
        })
      },
      { name: 'auth-routes', dependencies: ['auth'] }
    )
    ```

    **Update `backend/src/app.ts`:**
    - Remove `import { config } from './config.js'`
    - Import auth plugin: `import authPlugin from './auth/index.js'`
    - Register auth plugin BEFORE auth routes
    - Registration order: config -> db -> auth -> authRoutes
    ```typescript
    import configPlugin from './plugins/config.js'
    import db from './db/index.js'
    import authPlugin from './auth/index.js'
    import authRoutes from './routes/auth.js'

    // ... in buildApp:
    await app.register(configPlugin)
    await app.register(db)
    await app.register(authPlugin)
    await app.register(authRoutes)
    ```

    **Verify the full chain works:**
    ```bash
    cd backend && npx tsc --noEmit
    ```
    If there are type issues with the `fastify.auth` type (ReturnType of betterAuth), adjust the type declaration to be more specific or use the actual return type.
  </action>
  <verify>
    - `grep "import.*config" backend/src/db/client.ts` returns NO match (no config import)
    - `grep "import.*config" backend/src/auth/email.ts` returns NO match (no config import)
    - `grep "import.*config" backend/src/routes/auth.ts` returns NO match (no config import)
    - `grep "fastify.config" backend/src/db/index.ts` returns a match
    - `grep "fastify.config" backend/src/auth/index.ts` returns a match
    - `grep "fastify.auth" backend/src/routes/auth.ts` returns a match
    - `grep "void sendEmail" backend/src/auth/index.ts` returns NO match (fire-and-forget removed)
    - `grep "log.error" backend/src/auth/index.ts` returns a match (error logging added)
    - `grep "dependencies.*config" backend/src/db/index.ts` returns a match
    - `grep "dependencies.*db" backend/src/auth/index.ts` returns a match
    - `cd backend && npx tsc --noEmit` passes
  </verify>
  <done>
    All module-level singletons eliminated. Database client created inside db plugin. better-auth instance created inside auth plugin. Email transport created inside auth plugin. All modules access config via fastify.config. Email errors are logged instead of silently swallowed. Plugin dependency chain enforced: config -> db -> auth -> auth-routes.
  </done>
</task>

</tasks>

<verification>
1. `cd backend && npx tsc --noEmit` passes — no type errors
2. `ls backend/src/config.ts` does NOT exist — old config deleted
3. `ls backend/src/plugins/config.ts` exists — new config plugin
4. `grep -r "from.*config.js" backend/src/` shows ONLY the plugins/config.ts self-reference and app.ts import
5. `grep "closeWithGrace" backend/src/index.ts` confirms close-with-grace in use
6. `grep "process.on.*SIG" backend/src/index.ts` returns nothing — manual handlers removed
7. `grep "void sendEmail" backend/src/auth/index.ts` returns nothing — fire-and-forget removed
8. Start the dev stack: `docker compose -f compose.dev.yml up` — backend starts, health check responds, auth endpoints work
</verification>

<success_criteria>
- Config via @fastify/env, old config.ts deleted
- All plugins use fastify.config, no module-level config imports
- DB client created inside plugin, not at module scope
- Auth instance created inside plugin, not at module scope
- Email errors logged, not swallowed
- close-with-grace for shutdown
- TypeScript compiles with no errors
- Backend starts and serves health check
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-review-standards-update/02.1-03-SUMMARY.md`
</output>
