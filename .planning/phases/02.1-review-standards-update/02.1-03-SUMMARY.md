---
phase: 02.1-review-standards-update
plan: 03
subsystem: backend
tags: [fastify, config, plugins, close-with-grace, env-schema, typebox, better-auth, drizzle]

requires:
  - phase: 02.1-review-standards-update
    provides: Clean backend dependencies (Plan 02) and standards documentation (Plan 01)
provides:
  - "@fastify/env config plugin replacing hand-rolled config.ts"
  - "Plugin-scoped initialization for db and auth (no module-level singletons)"
  - "Graceful shutdown via close-with-grace"
  - "Email error logging (no fire-and-forget)"
  - "Enforced plugin dependency chain: config -> db -> auth -> auth-routes"
affects: [03-dashboard-auth-frontend, 04-github-integration]

tech-stack:
  added:
    - "@fastify/env ^5.0.3 (config validation as Fastify plugin)"
    - "close-with-grace ^2.4.0 (graceful shutdown)"
  patterns:
    - "@fastify/env with TypeBox schema for config validation and type-safe fastify.config"
    - "Plugin-scoped initialization: db/auth clients created inside Fastify plugins, not at module scope"
    - "Factory functions for db client and email sender (not singletons)"
    - "close-with-grace replaces manual process.on signal handlers"
    - "Plugin dependencies declared explicitly via dependencies array"

key-files:
  created:
    - backend/src/plugins/config.ts
  modified:
    - backend/package.json
    - backend/package-lock.json
    - backend/src/app.ts
    - backend/src/index.ts
    - backend/src/db/client.ts
    - backend/src/db/index.ts
    - backend/src/auth/index.ts
    - backend/src/auth/email.ts
    - backend/src/routes/auth.ts

key-decisions:
  - "process.env.NODE_ENV read directly in app.ts for logger bootstrap (documented single exception)"
  - "Config plugin wraps @fastify/env (which is already fp-wrapped) with name 'config' for dependency graph"
  - "Auth plugin destructures fastify.config for readability"
  - "Email errors caught and logged via fastify.log.error instead of void fire-and-forget"

duration: 5min
completed: 2026-02-05
---

# Phase 2.1 Plan 03: Config Refactor Summary

**Replaced hand-rolled config.ts with @fastify/env plugin, moved db/auth initialization into Fastify plugins, replaced manual shutdown with close-with-grace, fixed email error swallowing**

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-05T20:49:40Z
- **Completed:** 2026-02-05T20:54:58Z
- **Tasks:** 2
- **Files modified:** 10 (1 created, 1 deleted, 8 modified)

## Accomplishments

- Replaced hand-rolled `config.ts` (60+ lines of custom env helpers) with `@fastify/env` plugin using TypeBox schema
- Eliminated all module-level singletons: db client, better-auth instance, and email transporter now created inside Fastify plugins
- Established plugin dependency chain: `config -> db -> auth -> auth-routes` with explicit `dependencies` arrays
- Replaced manual `process.on(SIGINT/SIGTERM)` with `close-with-grace` for better edge case handling
- Fixed fire-and-forget `void sendEmail()` -- email failures now caught and logged via `fastify.log.error`
- All source files access config through `fastify.config` (no direct config imports outside the plugin)

## Task Commits

Each task was committed atomically:

1. **Task 1: Install new deps, create @fastify/env config plugin, update index.ts with close-with-grace** - `5fdf5ba` (refactor)
2. **Task 2: Restructure db and auth modules to plugin-scoped initialization** - `e41ce0c` (refactor)

## Files Created/Modified

- `backend/src/plugins/config.ts` - NEW: @fastify/env plugin with TypeBox schema, Config type export, FastifyInstance augmentation
- `backend/src/config.ts` - DELETED: Hand-rolled env validation with requireEnv/optionalEnv helpers
- `backend/src/app.ts` - Register config plugin first, then db, auth, auth-routes; logger bootstrap reads process.env.NODE_ENV directly (documented exception)
- `backend/src/index.ts` - close-with-grace replaces manual signal handlers; server config from app.config
- `backend/src/db/client.ts` - Factory function `createDbClient(config)` instead of module-level singleton
- `backend/src/db/index.ts` - Creates db client inside plugin using fastify.config, adds dependencies: ['config']
- `backend/src/auth/index.ts` - Fastify plugin creating better-auth inside lifecycle, dependencies: ['config', 'db'], email errors logged
- `backend/src/auth/email.ts` - Factory function `createEmailSender(config)` instead of module-level transporter
- `backend/src/routes/auth.ts` - Uses fastify.auth instead of direct import, dependencies: ['auth']
- `backend/package.json` - Added @fastify/env, close-with-grace

## Decisions Made

- **Logger bootstrap exception:** `process.env.NODE_ENV` read directly in `app.ts` for logger configuration at Fastify instantiation time. This is before any plugins can run, so it is the single documented exception to the "no process.env outside config" rule.
- **Config plugin naming:** The config plugin wraps `@fastify/env` and is named `'config'` in the dependency graph. Other plugins declare `dependencies: ['config']` to enforce registration order.
- **Auth config destructuring:** `const { config } = fastify` used in auth plugin for readability. Semantically identical to `fastify.config.*` access.
- **Email error handling:** Changed from `void sendEmail(...)` (silent promise rejection) to `try { await sendEmail(...) } catch (err) { fastify.log.error(...) }`. Errors are now logged with email, type context.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

- **Pre-existing scripts/migrate.ts type error:** The `scripts/migrate.ts` file has a `TS2769` error when type-checked against `tsconfig.base.json` due to `exactOptionalPropertyTypes` making `process.env.*` typed as `string | undefined` while `postgres()` expects `string`. This is a pre-existing issue (not caused by this plan) and is excluded from the build config (`tsconfig.build.json` excludes `scripts/**`). Not fixed here as it is outside the scope of this plan.

## Next Phase Readiness

- Backend architecture now follows Fastify plugin patterns throughout
- Config via @fastify/env with TypeBox schema provides type-safe `fastify.config`
- Plugin dependency chain ensures correct initialization order
- Ready for Plan 04 (remaining frontend/infrastructure review items)
- Ready for Phase 3 (Dashboard Shell & Auth Frontend) -- backend API is structurally clean

---
*Phase: 02.1-review-standards-update*
*Completed: 2026-02-05*
