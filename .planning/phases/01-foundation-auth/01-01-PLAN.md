---
phase: 01-foundation-auth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/auth/index.ts
  - backend/src/auth/schema.ts
  - backend/src/plugins/auth.ts
  - backend/src/db/schema/index.ts
  - backend/package.json
  - frontend/package.json
  - frontend/vite.config.ts
  - frontend/tailwind.config.ts
  - frontend/index.html
  - frontend/src/main.tsx
  - frontend/src/App.tsx
  - frontend/src/routes/index.tsx
  - frontend/src/routes/ProtectedRoute.tsx
  - frontend/src/features/auth/lib/auth-client.ts
  - frontend/src/shared/hooks/useTheme.ts
  - frontend/src/index.css
autonomous: true
user_setup:
  - service: github-oauth
    why: "GitHub OAuth login requires OAuth App credentials"
    env_vars:
      - name: GITHUB_CLIENT_ID
        source: "GitHub Settings -> Developer settings -> OAuth Apps -> New OAuth App"
      - name: GITHUB_CLIENT_SECRET
        source: "Same OAuth App page after creation"
    dashboard_config:
      - task: "Create OAuth App with callback URL http://localhost:3000/api/auth/callback/github"
        location: "https://github.com/settings/developers"

must_haves:
  truths:
    - "Backend starts without errors with auth plugin loaded"
    - "Auth database tables exist (user, session, account, verification)"
    - "Frontend dev server starts and shows placeholder page"
    - "Tailwind dark mode class toggle works"
  artifacts:
    - path: "backend/src/auth/index.ts"
      provides: "better-auth instance with Drizzle adapter"
      contains: "betterAuth"
    - path: "backend/src/plugins/auth.ts"
      provides: "Fastify plugin mounting auth endpoints"
      contains: "fastify.all"
    - path: "frontend/src/features/auth/lib/auth-client.ts"
      provides: "better-auth React client"
      contains: "createAuthClient"
    - path: "frontend/src/routes/ProtectedRoute.tsx"
      provides: "Route guard for authenticated pages"
      contains: "useSession"
  key_links:
    - from: "backend/src/plugins/auth.ts"
      to: "backend/src/auth/index.ts"
      via: "import auth instance"
      pattern: "import.*auth.*from"
    - from: "frontend/src/features/auth/lib/auth-client.ts"
      to: "http://localhost:3000/api/auth"
      via: "baseURL configuration"
      pattern: "baseURL.*localhost:3000"
---

<objective>
Set up backend authentication with better-auth and scaffold the React frontend with Vite

Purpose: Establish the authentication infrastructure and frontend foundation that all other Phase 1 work builds upon. Backend provides auth endpoints, frontend provides the shell for auth UI and dashboard.

Output: Working backend with auth endpoints at /api/auth/*, working frontend dev server with routing and Tailwind configured
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/01-CONTEXT.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@backend/src/index.ts
@backend/src/db/schema/users.ts
@backend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure better-auth with Drizzle adapter</name>
  <files>
    backend/src/auth/index.ts
    backend/src/auth/schema.ts
    backend/src/plugins/auth.ts
    backend/src/db/schema/index.ts
    backend/src/index.ts
    backend/package.json
  </files>
  <action>
1. Install better-auth dependencies:
   ```bash
   cd backend && npm install better-auth resend
   ```

2. Generate better-auth schema using CLI (or create manually based on docs):
   Create `backend/src/auth/schema.ts` with auth tables (user, session, account, verification).
   The user table should extend the existing users table concept but follow better-auth's expected schema.
   Use `text` for id fields (better-auth uses string IDs by default).

3. Create `backend/src/auth/index.ts` - better-auth instance:
   - Use drizzleAdapter with PostgreSQL provider
   - Configure emailAndPassword: enabled, minPasswordLength 8, requireEmailVerification false (non-blocking per CONTEXT.md)
   - Configure socialProviders.github with env vars GITHUB_CLIENT_ID, GITHUB_CLIENT_SECRET
   - Configure session: expiresIn 30 days, updateAge 1 day, cookieCache enabled (5 min)
   - Set trustedOrigins to include FRONTEND_URL env var (default http://localhost:5173)
   - For email callbacks (sendVerificationEmail, sendResetPassword), create placeholder functions that log to console (actual email sending in Plan 03)

4. Create `backend/src/plugins/auth.ts` - Fastify plugin:
   - Use fastify-plugin to wrap the handler
   - Mount better-auth handler at `/api/auth/*` using `fastify.all()`
   - Convert Fastify request/reply to Web Request/Response as shown in RESEARCH.md
   - Ensure headers are properly forwarded (especially cookies)

5. Update `backend/src/db/schema/index.ts` to export auth schema tables

6. Register auth plugin in `backend/src/index.ts` AFTER cors plugin

7. Add to backend/.env.example:
   ```
   GITHUB_CLIENT_ID=
   GITHUB_CLIENT_SECRET=
   FRONTEND_URL=http://localhost:5173
   ```
  </action>
  <verify>
    Run `cd backend && npm run dev` - server should start without errors.
    Check logs show auth plugin registered.
    Run `curl http://localhost:3000/api/auth/get-session` - should return JSON (empty session is fine).
  </verify>
  <done>
    Backend starts successfully with better-auth plugin loaded. GET /api/auth/get-session returns valid JSON response (even if empty session). Database has auth tables after migration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Scaffold React frontend with Vite and routing</name>
  <files>
    frontend/package.json
    frontend/vite.config.ts
    frontend/tailwind.config.ts
    frontend/postcss.config.js
    frontend/index.html
    frontend/src/main.tsx
    frontend/src/App.tsx
    frontend/src/index.css
    frontend/src/routes/index.tsx
    frontend/src/routes/ProtectedRoute.tsx
    frontend/src/features/auth/lib/auth-client.ts
    frontend/src/shared/hooks/useTheme.ts
    frontend/tsconfig.json
    frontend/.env.example
  </files>
  <action>
1. Create frontend directory and initialize Vite React TypeScript project:
   ```bash
   npm create vite@latest frontend -- --template react-ts
   cd frontend
   npm install
   ```

2. Install additional dependencies:
   ```bash
   npm install react-router-dom @tanstack/react-query better-auth
   npm install -D tailwindcss @tailwindcss/vite
   ```

3. Configure Vite (`vite.config.ts`):
   - Add @tailwindcss/vite plugin
   - Set server port to 5173
   - Configure proxy for /api to localhost:3000 (backend)

4. Configure Tailwind v4 (`tailwind.config.ts`):
   - Use CSS-based config (Tailwind v4 style)
   - Enable dark mode via class strategy
   - Set content paths for src/**/*.{ts,tsx}

5. Create `frontend/src/index.css`:
   - Import Tailwind with @import "tailwindcss"
   - Add CSS variables for theme colors (can be minimal for now)
   - Set dark mode variables using .dark class

6. Create `frontend/src/features/auth/lib/auth-client.ts`:
   - Export createAuthClient configured with baseURL from env var VITE_API_URL (default http://localhost:3000)
   - Export useSession, signIn, signUp, signOut hooks

7. Create `frontend/src/shared/hooks/useTheme.ts`:
   - Manage theme state: 'light' | 'dark' | 'system'
   - Persist to localStorage
   - Apply 'dark' class to document.documentElement
   - Listen for system preference changes when theme is 'system'

8. Create `frontend/src/routes/ProtectedRoute.tsx`:
   - Use useSession from auth-client
   - Show loading state while session loads
   - Redirect to /auth if not authenticated
   - Render Outlet if authenticated

9. Create `frontend/src/routes/index.tsx`:
   - Define routes using react-router-dom createBrowserRouter
   - Public routes: /auth (placeholder for now)
   - Protected routes: /dashboard, /settings (placeholders)
   - Root redirect to /dashboard if authenticated, /auth if not

10. Update `frontend/src/App.tsx`:
    - Wrap with QueryClientProvider (TanStack Query)
    - Render RouterProvider

11. Update `frontend/src/main.tsx`:
    - Import index.css
    - Render App component

12. Add inline script to `frontend/index.html` head to prevent flash of wrong theme:
    ```html
    <script>
      (function() {
        const theme = localStorage.getItem('theme') || 'system';
        const isDark = theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
        if (isDark) document.documentElement.classList.add('dark');
      })();
    </script>
    ```

13. Create `frontend/.env.example`:
    ```
    VITE_API_URL=http://localhost:3000
    ```

Note: Use relative imports within frontend. Do NOT use path aliases yet - keep it simple.
  </action>
  <verify>
    Run `cd frontend && npm run dev` - dev server should start on port 5173.
    Open http://localhost:5173 - should show placeholder content without errors.
    Check browser console for any errors.
    Toggle system dark mode - page should respond (if useTheme is wired up).
  </verify>
  <done>
    Frontend dev server runs on port 5173. React Router loads without errors. Tailwind styles apply correctly. Dark mode toggle works (class on html element changes). No console errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Run database migration for auth tables</name>
  <files>
    backend/drizzle.config.ts
    backend/migrations/*
  </files>
  <action>
1. Ensure drizzle.config.ts includes the auth schema in the schema path

2. Generate migration for auth tables:
   ```bash
   cd backend && npx drizzle-kit generate
   ```

3. Apply migration:
   ```bash
   cd backend && npx drizzle-kit migrate
   ```
   Or if using push for development:
   ```bash
   cd backend && npx drizzle-kit push
   ```

4. Verify tables exist by checking database (via drizzle-kit studio or psql):
   - user table (better-auth's user table)
   - session table
   - account table (for OAuth)
   - verification table (for email verification tokens)

Note: The existing `users` table from the scaffold may conflict with better-auth's expected `user` table. If so, either:
- Rename better-auth's table in schema config, OR
- Remove the old users.ts and use better-auth's user table as the source of truth

Choose the cleaner path - better-auth's user table has all needed fields (id, name, email, emailVerified, image, createdAt, updatedAt).
  </action>
  <verify>
    Run `npx drizzle-kit studio` or connect to database and verify:
    - user table exists with columns: id, name, email, emailVerified, image, createdAt, updatedAt
    - session table exists
    - account table exists
    - verification table exists
  </verify>
  <done>
    All four auth tables (user, session, account, verification) exist in the database with correct schema. Backend can query these tables without errors.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Backend health check:
   ```bash
   curl http://localhost:3000/api/auth/get-session
   ```
   Should return: `{"session":null,"user":null}` or similar valid JSON

2. Frontend loads:
   - Visit http://localhost:5173
   - No console errors
   - Placeholder content renders

3. Database tables exist:
   - user, session, account, verification tables present

4. Dark mode works:
   - Open browser dev tools
   - Check document.documentElement has/doesn't have 'dark' class based on preference
</verification>

<success_criteria>
- Backend starts with auth plugin registered at /api/auth/*
- Frontend dev server runs with React Router and Tailwind
- Database contains all auth tables (user, session, account, verification)
- better-auth client is configured and exported for frontend use
- Protected route wrapper is ready for use
- Theme hook manages dark mode preference
- No TypeScript or runtime errors in either project
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-01-SUMMARY.md` documenting:
- Files created/modified
- Auth endpoints available
- Frontend structure established
- Any decisions made during implementation
- Commands to run both servers
</output>
