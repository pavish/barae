---
phase: 01-foundation-auth
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/features/auth/service.ts
  - backend/src/features/auth/routes.ts
  - frontend/src/features/auth/pages/VerifyEmailPage.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Initial verification email sent automatically when user signs up"
    - "Email verification link successfully verifies user"
    - "Password reset link uses frontend URL, not backend URL"
  artifacts:
    - path: "backend/src/features/auth/service.ts"
      provides: "better-auth config with emailVerification and baseURL"
      contains: "emailVerification"
    - path: "backend/src/features/auth/routes.ts"
      provides: "Custom resend-verification endpoint using better-auth API"
    - path: "frontend/src/features/auth/pages/VerifyEmailPage.tsx"
      provides: "Frontend verify page using authClient.$fetch"
  key_links:
    - from: "betterAuth config"
      to: "email service"
      via: "emailVerification.sendOnSignUp + sendVerificationEmail handler"
      pattern: "sendOnSignUp.*true"
    - from: "frontend VerifyEmailPage"
      to: "better-auth verify-email"
      via: "authClient.$fetch with query params"
      pattern: "\\$fetch.*verify-email"
---

<objective>
Fix 3 diagnosed email verification and password reset gaps from UAT testing.

Purpose: Users must be able to complete the full email verification and password reset flows without errors.

Output:
- Signup automatically sends verification email
- Verification links work (using better-auth's JWT tokens)
- Password reset links use correct frontend URL
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/01-UAT.md

Key files:
@backend/src/features/auth/service.ts
@backend/src/features/auth/routes.ts
@frontend/src/features/auth/pages/VerifyEmailPage.tsx
@frontend/src/features/auth/lib/auth-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix better-auth config for auto-send and baseURL</name>
  <files>backend/src/features/auth/service.ts</files>
  <action>
Modify the betterAuth() config in service.ts:

1. Add `baseURL` at the top level of the config (sibling to `basePath`):
   ```typescript
   baseURL: fastify.config.FRONTEND_URL || 'http://localhost:5173',
   ```
   This fixes Gap 3 - password reset emails will now use frontend URL.

2. Add `emailVerification` block as a NEW top-level config (NOT inside emailAndPassword):
   ```typescript
   emailVerification: {
     sendOnSignUp: true,
     sendVerificationEmail: async ({ user, url }: { user: { email: string }; url: string }) => {
       fastify.email.sendVerificationEmail(user.email, url)
     },
   },
   ```
   This fixes Gap 1 - signup will now auto-send verification email.

3. KEEP the existing `sendVerificationEmail` inside `emailAndPassword` block - it's used for resend flows.

4. KEEP `requireEmailVerification: false` - we want non-blocking verification.

The final structure should have:
- `baseURL` (new - top level)
- `emailVerification` block (new - top level)
- `emailAndPassword` block (existing - keep sendVerificationEmail for resend)
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd backend && npm run build
```
  </verify>
  <done>
- betterAuth config has `baseURL: fastify.config.FRONTEND_URL`
- betterAuth config has `emailVerification: { sendOnSignUp: true, sendVerificationEmail: ... }`
- Existing emailAndPassword block unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Update resend-verification to use better-auth API, update frontend</name>
  <files>backend/src/features/auth/routes.ts, frontend/src/features/auth/pages/VerifyEmailPage.tsx</files>
  <action>
This fixes Gap 2 - align token systems so verification links work.

**Backend (routes.ts):**

1. KEEP the custom `/api/v1/auth/verify-email` GET endpoint as-is for now.
   - The custom endpoint handles verification via database lookup
   - It works with hex tokens generated by resend-verification

2. MODIFY the `/api/v1/auth/resend-verification` POST endpoint to use better-auth's API:

   Replace the token generation logic (lines 58-75 approximately) with:
   ```typescript
   // Use better-auth's sendVerificationEmail API endpoint
   // This generates JWT tokens compatible with better-auth's verify-email
   await auth.api.sendVerificationEmail({
     body: {
       email: user.email,
       callbackURL: `${fastify.config.FRONTEND_URL || 'http://localhost:5173'}/auth/verify-email`,
     },
   })
   ```

   Full updated endpoint:
   ```typescript
   fastify.post(
     '/api/v1/auth/resend-verification',
     async (request: FastifyRequest, reply: FastifyReply) => {
       try {
         // Get session from cookie using better-auth
         const sessionCookie = request.cookies['better-auth.session_token']
         if (!sessionCookie) {
           return reply.status(401).send({ error: 'Not authenticated' })
         }

         // Cookie format is "token.signature" - extract just the token
         const sessionToken = sessionCookie.split('.')[0]

         // Look up session and user
         const sessions = await fastify.db.do
           .select({ userId: schema.session.userId })
           .from(schema.session)
           .where(eq(schema.session.token, sessionToken))
           .limit(1)

         if (sessions.length === 0) {
           return reply.status(401).send({ error: 'Invalid session' })
         }

         const users = await fastify.db.do
           .select({
             id: schema.user.id,
             email: schema.user.email,
             emailVerified: schema.user.emailVerified,
           })
           .from(schema.user)
           .where(eq(schema.user.id, sessions[0].userId))
           .limit(1)

         if (users.length === 0) {
           return reply.status(404).send({ error: 'User not found' })
         }

         const user = users[0]

         if (user.emailVerified) {
           return reply.status(400).send({ error: 'Email already verified' })
         }

         // Use better-auth's sendVerificationEmail API
         await auth.api.sendVerificationEmail({
           body: {
             email: user.email,
             callbackURL: `${fastify.config.FRONTEND_URL || 'http://localhost:5173'}/auth/verify-email`,
           },
         })

         return reply.send({ success: true })
       } catch (err) {
         fastify.log.error({ err }, 'Failed to resend verification email')
         return reply.status(500).send({ error: 'Failed to send verification email' })
       }
     }
   )
   ```

3. DELETE the custom `/api/v1/auth/verify-email` GET endpoint (lines 85-149 approximately).
   - better-auth's built-in verify-email endpoint will handle verification
   - The catch-all `fastify.all('/api/v1/auth/*', handler)` routes to better-auth

4. Remove unused imports: `randomBytes` from `crypto` (no longer needed).

**Frontend (VerifyEmailPage.tsx):**

Update to use `authClient.$fetch` for the verification call. The `$fetch` method respects the configured `baseURL` and `basePath`.

Replace the fetch call in useEffect with:
```typescript
import { authClient } from '../lib/auth-client'

// In useEffect, replace the direct fetch:
const response = await authClient.$fetch<{ status?: boolean; user?: any }>('/verify-email', {
  method: 'GET',
  query: { token },
})

if (response.data?.status || response.data?.user) {
  setState('success')
  setTimeout(() => navigate('/dashboard'), 2000)
} else {
  setState('error')
  setErrorMessage(response.error?.message || 'Verification failed')
}
```

Note: `authClient.$fetch` automatically:
- Uses the configured baseURL (`VITE_API_URL`)
- Appends the basePath (`/api/v1/auth`)
- So `/verify-email` becomes `{VITE_API_URL}/api/v1/auth/verify-email?token=...`

Full updated component:
```typescript
import { useEffect, useState } from 'react'
import { useSearchParams, useNavigate, Link } from 'react-router-dom'
import { Card } from '../../../shared/components'
import { authClient } from '../lib/auth-client'

type VerifyState = 'loading' | 'success' | 'error'

export function VerifyEmailPage() {
  const [searchParams] = useSearchParams()
  const navigate = useNavigate()
  const token = searchParams.get('token')

  const [state, setState] = useState<VerifyState>('loading')
  const [errorMessage, setErrorMessage] = useState('')

  useEffect(() => {
    if (!token) {
      setState('error')
      setErrorMessage('No verification token provided')
      return
    }

    async function verifyEmail() {
      try {
        const response = await authClient.$fetch<{ status?: boolean; user?: any }>('/verify-email', {
          method: 'GET',
          query: { token },
        })

        if (response.data?.status || response.data?.user) {
          setState('success')
          setTimeout(() => navigate('/dashboard'), 2000)
        } else {
          setState('error')
          setErrorMessage(response.error?.message || 'Verification failed')
        }
      } catch {
        setState('error')
        setErrorMessage('Failed to connect to server')
      }
    }

    verifyEmail()
  }, [token, navigate])

  // ... rest of JSX unchanged
}
```
  </action>
  <verify>
1. Backend compiles:
```bash
cd backend && npm run build
```

2. Frontend compiles:
```bash
cd frontend && npm run build
```

3. Test the flow manually:
   - Sign up with new email
   - Check Mailpit (http://localhost:8025) - verification email should arrive automatically
   - Click verification link - should succeed and redirect to dashboard
  </verify>
  <done>
- Custom verify-email GET endpoint removed from routes.ts (better-auth handles it)
- resend-verification uses `auth.api.sendVerificationEmail({ body: { email, callbackURL } })`
- Frontend VerifyEmailPage uses `authClient.$fetch('/verify-email', { method: 'GET', query: { token } })`
- All verification flows use better-auth's JWT tokens (no custom hex tokens)
  </done>
</task>

<task type="auto">
  <name>Task 3: Test all three fixed flows</name>
  <files>None (verification only)</files>
  <action>
Run the full verification flow to confirm all 3 gaps are fixed:

1. **Gap 1 - Auto-send on signup:**
   - Start fresh: delete any test users from previous testing
   - Sign up with a new email at http://localhost:5173/auth
   - Check Mailpit at http://localhost:8025 IMMEDIATELY after signup
   - Verification email should appear WITHOUT clicking resend

2. **Gap 2 - Verification link works:**
   - Click the verification link in the Mailpit email
   - Should redirect to /auth/verify-email?token=...
   - Page should show "Email verified!" success message
   - Should auto-redirect to /dashboard after 2 seconds
   - Dashboard should NOT show the yellow verification banner

3. **Gap 3 - Password reset URL:**
   - Log out
   - Go to /auth and click "Forgot password?"
   - Enter the verified email and submit
   - Check Mailpit for password reset email
   - The link in the email should start with http://localhost:5173 (frontend URL), NOT http://localhost:3000 (backend URL)
   - Click the link - should go to reset password page

Document any issues found. If all pass, the gaps are closed.
  </action>
  <verify>
All 3 UAT test cases now pass:
- Test 5: Resend verification - initial email sent on signup
- Test 6: Verify email via link - succeeds without "invalid token" error
- Test 8: Reset password via link - uses correct frontend URL
  </verify>
  <done>
- Signup sends verification email automatically (check Mailpit immediately after signup)
- Verification link works and verifies user (no "invalid token" error)
- Password reset link uses frontend URL (http://localhost:5173/...)
  </done>
</task>

</tasks>

<verification>
Run complete verification:

1. Backend builds: `cd backend && npm run build`
2. Frontend builds: `cd frontend && npm run build`
3. Manual flow test:
   - Fresh signup -> email appears in Mailpit immediately
   - Click verify link -> success page, user verified
   - Password reset -> link uses frontend URL

Check that existing functionality still works:
- Login with existing verified user
- Resend verification button still works
- Logout/login flow unchanged
</verification>

<success_criteria>
- [ ] `npm run build` passes in both backend and frontend
- [ ] New signup triggers immediate verification email in Mailpit
- [ ] Clicking verification link shows success (not "invalid token")
- [ ] Password reset email contains frontend URL (localhost:5173 or FRONTEND_URL)
- [ ] All 3 diagnosed UAT gaps are closed
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-04-SUMMARY.md` following the template.

Then update `01-UAT.md`:
- Change status from `diagnosed` to `resolved`
- Update Tests 5, 6, 8 results to `pass`
- Clear the Gaps section or mark as resolved
</output>
