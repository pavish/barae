---
phase: 01-foundation-auth
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/features/auth/service.ts
  - backend/src/features/auth/routes.ts
  - frontend/src/features/auth/pages/VerifyEmailPage.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Initial verification email sent automatically when user signs up"
    - "Email verification link successfully verifies user"
    - "Password reset link uses frontend URL, not backend URL"
  artifacts:
    - path: "backend/src/features/auth/service.ts"
      provides: "better-auth config with emailVerification and baseURL"
      contains: "emailVerification"
    - path: "backend/src/features/auth/routes.ts"
      provides: "Custom resend-verification endpoint only (no custom verify-email)"
    - path: "frontend/src/features/auth/pages/VerifyEmailPage.tsx"
      provides: "Frontend verify page using better-auth's verify-email endpoint"
  key_links:
    - from: "betterAuth config"
      to: "email service"
      via: "emailVerification.sendOnSignUp + sendVerificationEmail handler"
      pattern: "sendOnSignUp.*true"
    - from: "frontend VerifyEmailPage"
      to: "better-auth verify-email"
      via: "authClient.verifyEmail"
      pattern: "authClient.*verifyEmail"
---

<objective>
Fix 3 diagnosed email verification and password reset gaps from UAT testing.

Purpose: Users must be able to complete the full email verification and password reset flows without errors.

Output:
- Signup automatically sends verification email
- Verification links work (using better-auth's JWT tokens)
- Password reset links use correct frontend URL
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/01-UAT.md

Key files:
@backend/src/features/auth/service.ts
@backend/src/features/auth/routes.ts
@frontend/src/features/auth/pages/VerifyEmailPage.tsx
@frontend/src/features/auth/lib/auth-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix better-auth config for auto-send and baseURL</name>
  <files>backend/src/features/auth/service.ts</files>
  <action>
Modify the betterAuth() config in service.ts:

1. Add `baseURL` at the top level of the config (sibling to `basePath`):
   ```typescript
   baseURL: fastify.config.FRONTEND_URL || 'http://localhost:5173',
   ```
   This fixes Gap 3 - password reset emails will now use frontend URL.

2. Add `emailVerification` block as a NEW top-level config (NOT inside emailAndPassword):
   ```typescript
   emailVerification: {
     sendOnSignUp: true,
     sendVerificationEmail: async ({ user, url }: { user: { email: string }; url: string }) => {
       fastify.email.sendVerificationEmail(user.email, url)
     },
   },
   ```
   This fixes Gap 1 - signup will now auto-send verification email.

3. KEEP the existing `sendVerificationEmail` inside `emailAndPassword` block - it's used for resend flows.

4. KEEP `requireEmailVerification: false` - we want non-blocking verification.

The final structure should have:
- `baseURL` (new - top level)
- `emailVerification` block (new - top level)
- `emailAndPassword` block (existing - keep sendVerificationEmail for resend)
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd backend && npm run build
```
  </verify>
  <done>
- betterAuth config has `baseURL: fastify.config.FRONTEND_URL`
- betterAuth config has `emailVerification: { sendOnSignUp: true, sendVerificationEmail: ... }`
- Existing emailAndPassword block unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove custom verify-email endpoint, align to better-auth</name>
  <files>backend/src/features/auth/routes.ts, frontend/src/features/auth/pages/VerifyEmailPage.tsx, frontend/src/features/auth/lib/auth-client.ts</files>
  <action>
This fixes Gap 2 - the incompatible token systems.

**Backend (routes.ts):**
1. DELETE the entire custom `/api/v1/auth/verify-email` GET endpoint (lines 85-149 approximately)
   - This endpoint uses random hex tokens stored in DB
   - better-auth uses JWT tokens that don't need DB lookup
   - The catch-all `fastify.all('/api/v1/auth/*', handler)` will route to better-auth's built-in verify-email

2. KEEP the `/api/v1/auth/resend-verification` POST endpoint BUT modify it:
   - Instead of generating random hex tokens, use better-auth's built-in sendVerificationEmail
   - The endpoint should call the auth service to send verification email

   Replace the token generation logic (lines 58-75 approximately) with:
   ```typescript
   // Use better-auth's internal method to send verification email
   // This generates JWT tokens compatible with better-auth's verify-email endpoint
   const baseUrl = fastify.config.FRONTEND_URL || 'http://localhost:5173'
   const verifyUrl = `${baseUrl}/auth/verify-email`

   // Call better-auth's sendVerificationEmail which generates JWT token
   await auth.api.sendVerificationEmail({
     body: {
       email: user.email,
       callbackURL: verifyUrl,
     },
   })
   ```

   Note: Import `auth` parameter is already available from `registerAuthRoutes(fastify, auth)`

3. Remove unused imports if any (randomBytes from crypto if no longer needed)

**Frontend (VerifyEmailPage.tsx):**
1. Change verification flow to use better-auth client instead of direct fetch
2. Get token from URL query param
3. Call better-auth's verifyEmail method

Replace the fetch call in useEffect with:
```typescript
import { authClient } from '../lib/auth-client'

// In useEffect:
const response = await authClient.verifyEmail({
  token: token,
})

if (response.data) {
  setState('success')
  setTimeout(() => navigate('/dashboard'), 2000)
} else {
  setState('error')
  setErrorMessage(response.error?.message || 'Verification failed')
}
```

**Frontend (auth-client.ts):**
Add verifyEmail export if not already present (check better-auth/react exports).
  </action>
  <verify>
1. Backend compiles:
```bash
cd backend && npm run build
```

2. Frontend compiles:
```bash
cd frontend && npm run build
```

3. Test the flow manually:
   - Sign up with new email
   - Check Mailpit (http://localhost:8025) - verification email should arrive automatically
   - Click verification link - should succeed and redirect to dashboard
  </verify>
  <done>
- Custom verify-email GET endpoint removed from routes.ts
- resend-verification uses better-auth's sendVerificationEmail API
- Frontend VerifyEmailPage uses authClient.verifyEmail
- All verification flows use better-auth's JWT tokens (no custom hex tokens)
  </done>
</task>

<task type="auto">
  <name>Task 3: Test all three fixed flows</name>
  <files>None (verification only)</files>
  <action>
Run the full verification flow to confirm all 3 gaps are fixed:

1. **Gap 1 - Auto-send on signup:**
   - Start fresh: delete any test users from previous testing
   - Sign up with a new email at http://localhost:5173/auth
   - Check Mailpit at http://localhost:8025 IMMEDIATELY after signup
   - Verification email should appear WITHOUT clicking resend

2. **Gap 2 - Verification link works:**
   - Click the verification link in the Mailpit email
   - Should redirect to /auth/verify-email?token=...
   - Page should show "Email verified!" success message
   - Should auto-redirect to /dashboard after 2 seconds
   - Dashboard should NOT show the yellow verification banner

3. **Gap 3 - Password reset URL:**
   - Log out
   - Go to /auth and click "Forgot password?"
   - Enter the verified email and submit
   - Check Mailpit for password reset email
   - The link in the email should start with http://localhost:5173 (frontend URL), NOT http://localhost:3000 (backend URL)
   - Click the link - should go to reset password page

Document any issues found. If all pass, the gaps are closed.
  </action>
  <verify>
All 3 UAT test cases now pass:
- Test 5: Resend verification - initial email sent on signup
- Test 6: Verify email via link - succeeds without "invalid token" error
- Test 8: Reset password via link - uses correct frontend URL
  </verify>
  <done>
- Signup sends verification email automatically (check Mailpit immediately after signup)
- Verification link works and verifies user (no "invalid token" error)
- Password reset link uses frontend URL (http://localhost:5173/...)
  </done>
</task>

</tasks>

<verification>
Run complete verification:

1. Backend builds: `cd backend && npm run build`
2. Frontend builds: `cd frontend && npm run build`
3. Manual flow test:
   - Fresh signup -> email appears in Mailpit immediately
   - Click verify link -> success page, user verified
   - Password reset -> link uses frontend URL

Check that existing functionality still works:
- Login with existing verified user
- Resend verification button still works
- Logout/login flow unchanged
</verification>

<success_criteria>
- [ ] `npm run build` passes in both backend and frontend
- [ ] New signup triggers immediate verification email in Mailpit
- [ ] Clicking verification link shows success (not "invalid token")
- [ ] Password reset email contains frontend URL (localhost:5173 or FRONTEND_URL)
- [ ] All 3 diagnosed UAT gaps are closed
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-04-SUMMARY.md` following the template.

Then update `01-UAT.md`:
- Change status from `diagnosed` to `resolved`
- Update Tests 5, 6, 8 results to `pass`
- Clear the Gaps section or mark as resolved
</output>
