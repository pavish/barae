---
phase: 01.3-review-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/package.json
  - backend/src/features/auth/routes.ts
  - backend/src/config.ts
  - frontend/src/shared/components/ErrorBoundary.tsx
  - frontend/src/shared/components/index.ts
  - frontend/src/App.tsx
  - frontend/src/features/dashboard/components/Header.tsx
autonomous: true

must_haves:
  truths:
    - "Rapid resend-verification requests are rejected after 3 per hour"
    - "Backend startup fails if APP_SECRET is less than 32 characters"
    - "React runtime errors show fallback UI instead of crashing the app"
    - "Clicking the Header logo navigates via SPA (no full page reload)"
  artifacts:
    - path: "backend/src/features/auth/routes.ts"
      provides: "Rate-limited resend-verification endpoint"
      contains: "rateLimit"
    - path: "backend/src/config.ts"
      provides: "APP_SECRET minimum length validation"
      contains: "minLength: 32"
    - path: "frontend/src/shared/components/ErrorBoundary.tsx"
      provides: "Error boundary component with fallback UI"
      exports: ["ErrorBoundary"]
    - path: "frontend/src/features/dashboard/components/Header.tsx"
      provides: "Header with React Router Link for logo"
      contains: "<Link"
  key_links:
    - from: "backend/src/features/auth/routes.ts"
      to: "@fastify/rate-limit"
      via: "route-level rate limiting config"
      pattern: "config:\\s*\\{.*max:"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/shared/components/ErrorBoundary.tsx"
      via: "wrapping RouterProvider"
      pattern: "<ErrorBoundary>"
---

<objective>
Implement the 4 code review recommendations from Phase 1.2 before proceeding to Phase 2.

Purpose: Address security hardening (rate limiting, secret validation) and frontend quality improvements (error handling, SPA navigation) identified in the code review report.

Output: Hardened backend auth endpoint, validated config, global error boundary, and proper SPA navigation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Source files to modify
@backend/src/features/auth/routes.ts
@backend/src/config.ts
@frontend/src/App.tsx
@frontend/src/features/dashboard/components/Header.tsx
@frontend/src/shared/components/index.ts

# Review report with detailed findings
@.planning/phases/01.2-code-review/01.2-REVIEW-REPORT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add rate limiting to /resend-verification endpoint</name>
  <files>
    backend/package.json
    backend/src/features/auth/routes.ts
  </files>
  <action>
1. Install @fastify/rate-limit:
   ```bash
   cd backend && npm install @fastify/rate-limit
   ```

2. In `backend/src/features/auth/routes.ts`, add rate limiting to the /resend-verification endpoint:
   - Import the rate limit plugin
   - Apply route-level rate limiting with these settings:
     - max: 3 requests
     - timeWindow: '1 hour' (3600000 ms)
     - keyGenerator: extract user ID from session (or fall back to IP if no session)
     - errorResponseBuilder: return 429 with message "Too many verification emails requested. Please try again later."

   The rate limiting should be applied ONLY to this endpoint, not globally, since better-auth's catch-all handles its own rate limiting.

   Implementation pattern:
   ```typescript
   import rateLimit from '@fastify/rate-limit'

   // Inside registerAuthRoutes, before the route:
   await fastify.register(rateLimit, {
     max: 3,
     timeWindow: '1 hour',
     keyGenerator: (request) => {
       // Use session user ID if available, fall back to IP
       const sessionCookie = request.cookies['better-auth.session_token']
       return sessionCookie?.split('.')[0] || request.ip
     },
     errorResponseBuilder: () => ({
       statusCode: 429,
       error: 'Too Many Requests',
       message: 'Too many verification emails requested. Please try again later.'
     })
   })
   ```

   Note: Register rate limit BEFORE the route definition within a scoped context (use `fastify.register` with a prefix or register rate limit with `addHook` for just this route).

   Best approach: Use route-specific rate limiting by registering in a scoped plugin:
   ```typescript
   // Wrap the resend-verification route in its own scope with rate limiting
   fastify.register(async (scope) => {
     await scope.register(rateLimit, { /* config */ })
     scope.post('/api/v1/auth/resend-verification', async (request, reply) => { /* handler */ })
   })
   ```
  </action>
  <verify>
    1. `cd backend && npm ls @fastify/rate-limit` shows package installed
    2. Backend starts without errors: `npm run dev` (in backend directory)
    3. Rate limit headers appear in response: `curl -I http://localhost:3000/api/v1/auth/resend-verification`
  </verify>
  <done>
    - @fastify/rate-limit installed in backend
    - /resend-verification endpoint rate limited to 3 requests per hour per user
    - 4th request within an hour returns 429 with appropriate message
  </done>
</task>

<task type="auto">
  <name>Task 2: Add APP_SECRET minimum length validation</name>
  <files>
    backend/src/config.ts
  </files>
  <action>
1. In `backend/src/config.ts`, update the APP_SECRET schema to require minimum 32 characters:

   Change from:
   ```typescript
   APP_SECRET: Type.String(),
   ```

   To:
   ```typescript
   APP_SECRET: Type.String({ minLength: 32 }),
   ```

   This ensures the application fails fast on startup if APP_SECRET is too short, preventing deployment with weak secrets.

2. Verify existing APP_SECRET in .env meets the requirement (should already be 32+ chars if following secure practices).
  </action>
  <verify>
    1. `grep -n "minLength: 32" backend/src/config.ts` shows the validation
    2. Backend starts successfully with current .env (secret should already be 32+ chars)
    3. Test failure case: temporarily set APP_SECRET to "short" in .env, backend should fail to start with validation error
  </verify>
  <done>
    - APP_SECRET validation requires minimum 32 characters
    - Backend fails fast on startup if secret is too short
    - Existing .env passes validation
  </done>
</task>

<task type="auto">
  <name>Task 3: Add ErrorBoundary and fix Header logo Link</name>
  <files>
    frontend/src/shared/components/ErrorBoundary.tsx
    frontend/src/shared/components/index.ts
    frontend/src/App.tsx
    frontend/src/features/dashboard/components/Header.tsx
  </files>
  <action>
**Part A: Create ErrorBoundary component**

1. Create `frontend/src/shared/components/ErrorBoundary.tsx`:

```typescript
import { Component, ReactNode } from 'react'

interface Props {
  children: ReactNode
  fallback?: ReactNode
}

interface State {
  hasError: boolean
  error: Error | null
}

export class ErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props)
    this.state = { hasError: false, error: null }
  }

  static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error }
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo): void {
    // Log error to console in development
    console.error('ErrorBoundary caught an error:', error, errorInfo)
  }

  render(): ReactNode {
    if (this.state.hasError) {
      if (this.props.fallback) {
        return this.props.fallback
      }

      return (
        <div className="min-h-screen flex items-center justify-center bg-[var(--color-background)]">
          <div className="text-center p-8 max-w-md">
            <h1 className="text-2xl font-bold text-[var(--color-foreground)] mb-4">
              Something went wrong
            </h1>
            <p className="text-[var(--color-muted-foreground)] mb-6">
              An unexpected error occurred. Please try refreshing the page.
            </p>
            <button
              onClick={() => window.location.reload()}
              className="px-4 py-2 bg-[var(--color-primary)] text-[var(--color-primary-foreground)] rounded-md hover:opacity-90 transition-opacity"
            >
              Refresh Page
            </button>
          </div>
        </div>
      )
    }

    return this.props.children
  }
}
```

2. Export from `frontend/src/shared/components/index.ts`:
   Add `export { ErrorBoundary } from './ErrorBoundary'`

3. Wrap app in ErrorBoundary in `frontend/src/App.tsx`:
   ```typescript
   import { ErrorBoundary } from './shared/components'

   function App() {
     return (
       <ErrorBoundary>
         <QueryClientProvider client={queryClient}>
           <RouterProvider router={router} />
         </QueryClientProvider>
       </ErrorBoundary>
     )
   }
   ```

**Part B: Fix Header logo to use React Router Link**

4. In `frontend/src/features/dashboard/components/Header.tsx`:
   - Add import: `import { Link } from 'react-router-dom'`
   - Replace the logo `<a>` tag with `<Link>`:

   Change from:
   ```tsx
   <a
     href="/dashboard"
     className="text-xl font-bold text-[var(--color-foreground)]"
   >
     Barae
   </a>
   ```

   To:
   ```tsx
   <Link
     to="/dashboard"
     className="text-xl font-bold text-[var(--color-foreground)]"
   >
     Barae
   </Link>
   ```
  </action>
  <verify>
    1. `grep -n "export.*ErrorBoundary" frontend/src/shared/components/index.ts` shows export
    2. `grep -n "<ErrorBoundary>" frontend/src/App.tsx` shows wrapping
    3. `grep -n "<Link" frontend/src/features/dashboard/components/Header.tsx` shows Link usage
    4. `npm run build` in frontend succeeds
    5. Manual test: In browser console on dashboard, run `throw new Error('test')` - should show error UI
    6. Manual test: Click logo in header - should navigate without full page reload (check Network tab)
  </verify>
  <done>
    - ErrorBoundary component created with styled fallback UI
    - ErrorBoundary wraps entire React app at root level
    - Header logo uses React Router Link for SPA navigation
    - Frontend builds successfully
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Rate Limiting Test:**
   - Start backend and frontend
   - Log in to the app
   - Trigger resend verification 4 times quickly
   - 4th request should return 429

2. **Config Validation Test:**
   - Temporarily set APP_SECRET="short" in backend .env
   - `npm run dev` in backend should fail with validation error
   - Restore proper APP_SECRET

3. **ErrorBoundary Test:**
   - Open browser console on any page
   - Run: `window.__THROW_TEST_ERROR__ = true` then trigger a React error
   - Should see fallback UI with "Something went wrong" message

4. **Header Link Test:**
   - Navigate to dashboard
   - Open Network tab in DevTools
   - Click the "Barae" logo
   - Should NOT see full page reload (no document request)

5. **Build Check:**
   - `cd backend && npm run build` succeeds
   - `cd frontend && npm run build` succeeds
</verification>

<success_criteria>
- [ ] Backend /resend-verification returns 429 after 3 requests in 1 hour
- [ ] Backend fails to start with APP_SECRET shorter than 32 characters
- [ ] React errors display fallback UI instead of white screen
- [ ] Header logo navigates via React Router (SPA, no reload)
- [ ] Both backend and frontend build successfully
- [ ] No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/01.3-review-fixes/01.3-01-SUMMARY.md`
</output>
