---
phase: 02-auth-backend
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - backend/src/auth/email.ts
  - backend/src/auth/index.ts
  - backend/src/routes/auth.ts
  - backend/src/app.ts
  - frontend/src/lib/auth.ts
autonomous: true

must_haves:
  truths:
    - "A new user can register with email/password via POST /api/auth/sign-up/email (creates user + automatically triggers OTP email — single API call)"
    - "Email verification is a separate second API call: user submits received OTP code via POST /api/auth/email-otp/verify-email to complete verification"
    - "A verified user can log in via POST /api/auth/sign-in/email and receives a session cookie"
    - "A logged-in user can request a password reset OTP and complete the reset"
    - "Sessions persist via httpOnly cookies (persist across browser closes)"
    - "A logged-in user can list active sessions via GET /api/auth/list-sessions"
    - "A logged-in user can revoke a specific session via POST /api/auth/revoke-session"
    - "A logged-in user can log out via POST /api/auth/sign-out"
  artifacts:
    - path: "backend/src/auth/index.ts"
      provides: "better-auth instance with emailOTP plugin"
      exports: ["auth"]
    - path: "backend/src/auth/email.ts"
      provides: "Email transport using nodemailer"
      exports: ["sendEmail"]
    - path: "backend/src/routes/auth.ts"
      provides: "Fastify catch-all route for better-auth"
      contains: "auth/\\*"
    - path: "frontend/src/lib/auth.ts"
      provides: "better-auth React client"
      exports: ["authClient"]
  key_links:
    - from: "backend/src/auth/index.ts"
      to: "backend/src/db/client.ts"
      via: "imports standalone db for Drizzle adapter"
      pattern: "import.*db.*client"
    - from: "backend/src/auth/index.ts"
      to: "backend/src/auth/email.ts"
      via: "calls sendEmail in OTP plugin callback"
      pattern: "sendEmail"
    - from: "backend/src/routes/auth.ts"
      to: "backend/src/auth/index.ts"
      via: "imports auth instance for handler"
      pattern: "import.*auth"
    - from: "backend/src/app.ts"
      to: "backend/src/routes/auth.ts"
      via: "registers auth route plugin"
      pattern: "register.*auth"
    - from: "frontend/src/lib/auth.ts"
      to: "/api/auth/*"
      via: "better-auth client with baseURL /api"
      pattern: "baseURL.*api"
---

<objective>
Create the complete better-auth integration: email transport, auth instance with email OTP plugin, Fastify catch-all route handler, and frontend auth client.

Purpose: This plan delivers the full authentication API. After completion, all Phase 2 auth flows work end-to-end: signup, email verification via OTP, login, password reset via OTP, session listing/revocation, and logout.

Output: Working auth API accessible through Caddy at /api/auth/*, plus a frontend auth client ready for Phase 3 UI integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-auth-backend/02-RESEARCH.md
@.planning/phases/02-auth-backend/02-01-SUMMARY.md
@.planning/codebase/STANDARDS.md
@backend/src/config.ts
@backend/src/app.ts
@backend/src/db/client.ts
@backend/src/db/schema/auth.ts
@frontend/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email transport, better-auth instance, and Fastify route</name>
  <files>
    backend/src/auth/email.ts
    backend/src/auth/index.ts
    backend/src/routes/auth.ts
    backend/src/app.ts
  </files>
  <action>
    **Create `backend/src/auth/email.ts` (email transport):**
    - Import `nodemailer` (default import) and `config` from `../config.js`
    - Create transporter: `nodemailer.createTransport({ host, port, secure })` from config.smtp
    - Add conditional auth: only include `{ auth: { user, pass } }` if `config.smtp.user` is non-empty (Mailpit in dev has no auth)
    - Export `sendEmail` function accepting `{ to, subject, text, html? }` that calls `transporter.sendMail` with `from: config.smtp.from`
    - Type the options with an `EmailOptions` interface

    **Create `backend/src/auth/index.ts` (better-auth instance):**
    - Import `betterAuth` from `better-auth`
    - Import `drizzleAdapter` from `better-auth/adapters/drizzle`
    - Import `emailOTP` from `better-auth/plugins`
    - Import `db` from `../db/client.js` (standalone Drizzle instance)
    - Import `* as schema` from `../db/schema/index.js`
    - Import `config` from `../config.js`
    - Import `sendEmail` from `./email.js`

    Configure `betterAuth`:
    ```
    export const auth = betterAuth({
      appName: 'Barae',
      baseURL: config.auth.baseURL,     // "http://localhost:8100/api"
      basePath: '/auth',                 // Caddy strips /api/, Fastify sees /auth/*
      secret: config.auth.secret,
      database: drizzleAdapter(db, {
        provider: 'pg',
        schema,
      }),
      emailAndPassword: {
        enabled: true,
        requireEmailVerification: true,
        minPasswordLength: 8,
        maxPasswordLength: 128,
        autoSignIn: true,
      },
      session: {
        expiresIn: 60 * 60 * 24 * 7,    // 7 days
        updateAge: 60 * 60 * 24,         // Refresh after 1 day
      },
      plugins: [
        emailOTP({
          otpLength: 6,
          expiresIn: 300,                // 5 minutes
          sendVerificationOTP: async ({ email, otp, type }) => {
            const subjects: Record<string, string> = {
              'email-verification': 'Verify your Barae email',
              'forget-password': 'Reset your Barae password',
              'sign-in': 'Your Barae sign-in code',
            }
            void sendEmail({
              to: email,
              subject: subjects[type] ?? 'Your Barae verification code',
              text: `Your verification code is: ${otp}\n\nThis code expires in 5 minutes.`,
            })
          },
        }),
      ],
      trustedOrigins: [config.auth.baseURL],
    })
    ```

    Key decisions:
    - `basePath: '/auth'` because Caddy strips `/api/` prefix (Fastify receives `/auth/*`)
    - `baseURL` includes `/api` for URL generation (cookies, redirects)
    - `void sendEmail(...)` is fire-and-forget to prevent timing attacks (per research)
    - `trustedOrigins` includes the baseURL for CSRF protection
    - Do NOT set BETTER_AUTH_SECRET or BETTER_AUTH_URL env vars (per research anti-patterns)
    - Do NOT apply @fastify/rate-limit to auth routes (better-auth has built-in rate limiting)

    **Create `backend/src/routes/auth.ts` (Fastify route plugin):**
    - Import `fp` from `fastify-plugin`
    - Import `auth` from `../auth/index.js`
    - Create a Fastify plugin that registers a catch-all route:
      ```
      fastify.route({
        method: ['GET', 'POST'],
        url: '/auth/*',
        handler: async (request, reply) => {
          // Convert Fastify request to Fetch API Request
          const url = new URL(request.url, `http://${request.headers.host}`)
          const headers = new Headers()
          for (const [key, value] of Object.entries(request.headers)) {
            if (value !== undefined) {
              headers.append(key, Array.isArray(value) ? value.join(', ') : value)
            }
          }
          const req = new Request(url.toString(), {
            method: request.method,
            headers,
            ...(request.body ? { body: JSON.stringify(request.body) } : {}),
          })
          const response = await auth.handler(req)
          reply.status(response.status)
          response.headers.forEach((value, key) => {
            reply.header(key, value)
          })
          const text = await response.text()
          return reply.send(text || null)
        },
      })
      ```
    - Export as default Fastify plugin using `fp()` with `{ name: 'auth-routes' }`

    **Update `backend/src/app.ts`:**
    - Import the auth routes plugin: `import authRoutes from './routes/auth.js'`
    - Register it after the db plugin: `await app.register(authRoutes)`
    - Keep existing health check endpoint unchanged

    Important: Do NOT add a `/auth/ok` health check separately -- better-auth provides one at `GET /auth/ok` automatically.
  </action>
  <verify>
    - `npx tsc --noEmit` in backend/ passes with no type errors
    - `backend/src/auth/email.ts` exports `sendEmail`
    - `backend/src/auth/index.ts` exports `auth` (betterAuth instance)
    - `backend/src/routes/auth.ts` exports a Fastify plugin with catch-all `/auth/*` route
    - `backend/src/app.ts` registers the auth routes plugin
    - Start the dev stack and run the following functional tests:
      1. `curl http://localhost:8100/api/auth/ok` returns 200 (better-auth health)
      2. `curl -X POST http://localhost:8100/api/auth/sign-up/email -H 'Content-Type: application/json' -d '{"name":"Test","email":"test@example.com","password":"testpass123"}' -c /tmp/claude/cookies.txt` returns 200 and creates a user
      3. Check Mailpit at http://localhost:8025 — an OTP verification email should appear for test@example.com
      4. Extract OTP from Mailpit (via `curl http://localhost:8025/api/v1/messages` API), then verify email: `curl -X POST http://localhost:8100/api/auth/email-otp/verify-email -H 'Content-Type: application/json' -d '{"email":"test@example.com","otp":"<CODE>"}' -b /tmp/claude/cookies.txt -c /tmp/claude/cookies.txt`
      5. `curl -X POST http://localhost:8100/api/auth/sign-in/email -H 'Content-Type: application/json' -d '{"email":"test@example.com","password":"testpass123"}' -c /tmp/claude/cookies.txt` returns 200 with session cookie
      6. `curl http://localhost:8100/api/auth/get-session -b /tmp/claude/cookies.txt` returns user/session data
      7. `curl -X POST http://localhost:8100/api/auth/sign-out -b /tmp/claude/cookies.txt` returns 200 and invalidates session
  </verify>
  <done>
    The better-auth instance is configured with email/password + emailOTP plugin, mounted on Fastify via catch-all route at `/auth/*`, and registered in app.ts. Email transport sends via nodemailer to Mailpit in dev.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create frontend auth client</name>
  <files>
    frontend/src/lib/auth.ts
  </files>
  <action>
    **Create `frontend/src/lib/auth.ts`:**
    - Import `createAuthClient` from `better-auth/react`
    - Import `emailOTPClient` from `better-auth/client/plugins`
    - Create and export the auth client:
      ```
      export const authClient = createAuthClient({
        baseURL: '/api',
        plugins: [
          emailOTPClient(),
        ],
      })
      ```

    Key decisions:
    - `baseURL: '/api'` uses relative path (same origin via Caddy, no env variables needed)
    - The `emailOTPClient()` plugin adds type-safe methods: `authClient.emailOtp.sendVerificationOtp()`, `authClient.emailOtp.verifyEmail()`, `authClient.emailOtp.resetPassword()`
    - This client provides React hooks like `authClient.useSession()` for Phase 3
    - No frontend env variables (per STANDARDS.md rule #2)
    - This file replaces the generic `apiFetch` for auth operations -- `apiFetch` remains for custom API routes

    The auth client provides all methods needed for Phase 2 requirements:
    - AUTH-01: `authClient.signUp.email()`
    - AUTH-02: `authClient.emailOtp.sendVerificationOtp()` + `authClient.emailOtp.verifyEmail()`
    - AUTH-03: `authClient.signIn.email()`
    - AUTH-05: `authClient.emailOtp.sendVerificationOtp({ type: 'forget-password' })` + `authClient.emailOtp.resetPassword()`
    - AUTH-06: Sessions use httpOnly cookies (persist automatically)
    - AUTH-07: `authClient.listSessions()` + `authClient.revokeSession()`
    - AUTH-08: `authClient.signOut()`
  </action>
  <verify>
    - `npx tsc --noEmit` in frontend/ passes with no type errors
    - `frontend/src/lib/auth.ts` exports `authClient`
    - The client uses `baseURL: '/api'` (no env variables)
    - The client includes the emailOTPClient plugin
  </verify>
  <done>
    Frontend auth client is configured with better-auth React integration and emailOTP plugin. It provides type-safe methods for all auth operations and React hooks for session management. Ready for Phase 3 UI integration.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes in both backend/ and frontend/
2. Auth instance created with email/password + emailOTP plugin + Drizzle adapter
3. Fastify registers catch-all `/auth/*` route
4. Email transport configured for Mailpit (dev) and SMTP (prod)
5. Frontend auth client created with `/api` base URL
6. All Phase 2 requirements have corresponding better-auth API routes:
   - AUTH-01 (signup): POST /api/auth/sign-up/email
   - AUTH-02 (verify email): POST /api/auth/email-otp/send-verification-otp + POST /api/auth/email-otp/verify-email
   - AUTH-03 (login): POST /api/auth/sign-in/email
   - AUTH-05 (password reset): POST /api/auth/email-otp/send-verification-otp (type: forget-password) + POST /api/auth/email-otp/reset-password
   - AUTH-06 (persistent sessions): Cookie-based sessions with 7-day expiry
   - AUTH-07 (session management): GET /api/auth/list-sessions + POST /api/auth/revoke-session
   - AUTH-08 (logout): POST /api/auth/sign-out
</verification>

<success_criteria>
- `curl -X POST http://localhost:8100/api/auth/sign-up/email` with valid JSON creates a user
- OTP verification email appears in Mailpit (http://localhost:8025)
- `curl -X POST http://localhost:8100/api/auth/sign-in/email` with verified user credentials returns a session cookie
- `curl http://localhost:8100/api/auth/get-session` with session cookie returns user data
- `curl -X POST http://localhost:8100/api/auth/sign-out` with session cookie invalidates the session
- Frontend auth client compiles with proper types for all auth operations
</success_criteria>

<output>
After completion, create `.planning/phases/02-auth-backend/02-02-SUMMARY.md`
</output>
