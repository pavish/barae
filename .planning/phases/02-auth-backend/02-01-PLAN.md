---
phase: 02-auth-backend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/db/client.ts
  - backend/src/db/index.ts
  - backend/src/db/schema/auth.ts
  - backend/src/db/schema/index.ts
  - backend/src/config.ts
  - .env.example
autonomous: true

must_haves:
  truths:
    - "A standalone Drizzle db instance exists that can be imported outside Fastify lifecycle"
    - "The Fastify db plugin reuses the standalone instance (no duplicate connections)"
    - "Auth schema defines user, session, account, and verification tables with proper relations"
    - "Config module exports auth.baseURL from AUTH_BASE_URL env var"
    - "Drizzle migration can be generated from the auth schema"
  artifacts:
    - path: "backend/src/db/client.ts"
      provides: "Standalone postgres.js client and Drizzle instance"
      exports: ["client", "db"]
    - path: "backend/src/db/schema/auth.ts"
      provides: "better-auth schema tables (user, session, account, verification)"
      contains: "pgTable"
    - path: "backend/src/db/schema/index.ts"
      provides: "Barrel export including auth schema"
      contains: "auth"
  key_links:
    - from: "backend/src/db/client.ts"
      to: "backend/src/config.ts"
      via: "imports config.db for connection params"
      pattern: "import.*config"
    - from: "backend/src/db/index.ts"
      to: "backend/src/db/client.ts"
      via: "imports standalone client, wraps in Fastify plugin"
      pattern: "import.*client"
---

<objective>
Extract the Drizzle database connection into a standalone module, create the better-auth database schema, and extend the config module with auth URL settings.

Purpose: better-auth requires a Drizzle instance at module level (not inside Fastify's plugin lifecycle). The auth schema tables must exist before better-auth can be initialized. The config module needs AUTH_BASE_URL for better-auth's URL generation.

Output: Standalone db client, auth schema with migration, and config ready for better-auth initialization in Plan 02-02.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-auth-backend/02-RESEARCH.md
@.planning/codebase/STANDARDS.md
@backend/src/config.ts
@backend/src/db/index.ts
@backend/src/db/schema/index.ts
@backend/drizzle.config.ts
@backend/scripts/migrate.ts
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract standalone Drizzle client and refactor Fastify db plugin</name>
  <files>
    backend/src/db/client.ts
    backend/src/db/index.ts
  </files>
  <action>
    Create `backend/src/db/client.ts` as the standalone database module:
    - Import `postgres` from `postgres` and `drizzle` from `drizzle-orm/postgres-js`
    - Import `config` from `../config.js`
    - Import `* as dbSchema` from `./schema/index.js`
    - Create and export `const client = postgres({ host, port, database, username, password })` using config.db values
    - Create and export `const db = drizzle(client, { schema: dbSchema })`
    - Export `dbSchema` as `schema` for convenience

    Refactor `backend/src/db/index.ts` (Fastify plugin):
    - Remove the `createDbHandler` function and inline postgres/drizzle creation
    - Instead, import `client` and `db` from `./client.js`
    - Import `* as dbSchema` from `./schema/index.js`
    - The plugin now decorates Fastify with `{ client, schema: dbSchema, do: db }` (same shape as before)
    - Keep the `onClose` hook that calls `client.end()`
    - Keep the `declare module 'fastify'` augmentation with the same `FastifyInstance.db` type
    - The `db` property on the Fastify instance keeps the same interface: `{ client, schema, do }` where `do` is the Drizzle instance

    Why: better-auth needs a Drizzle instance at module level. The current db is created inside a Fastify plugin. This refactor extracts the connection so both Fastify and better-auth share the same database connection.
  </action>
  <verify>
    - `npx tsc --noEmit` in backend/ passes with no type errors
    - `backend/src/db/client.ts` exports `client`, `db`, and `schema`
    - `backend/src/db/index.ts` imports from `./client.js` (no inline postgres creation)
    - The Fastify `db` decoration has the same shape (`db.client`, `db.schema`, `db.do`)
  </verify>
  <done>
    A standalone Drizzle instance exists at `backend/src/db/client.ts` that can be imported by any module. The Fastify db plugin reuses this instance with no duplicate connections. Existing code using `app.db.do` continues to work unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create auth schema, update config, and generate migration</name>
  <files>
    backend/src/db/schema/auth.ts
    backend/src/db/schema/index.ts
    backend/src/config.ts
    .env.example
  </files>
  <action>
    **Create `backend/src/db/schema/auth.ts`:**
    Define the four tables better-auth requires using Drizzle pgTable:

    1. `user` table: id (text PK), name (text not null), email (text not null unique), emailVerified (boolean not null default false), image (text nullable), createdAt (timestamp not null defaultNow), updatedAt (timestamp not null defaultNow)
    2. `session` table: id (text PK), userId (text not null, FK -> user.id cascade delete), token (text not null unique), expiresAt (timestamp not null), ipAddress (text nullable), userAgent (text nullable), createdAt (timestamp not null defaultNow), updatedAt (timestamp not null defaultNow)
    3. `account` table: id (text PK), userId (text not null, FK -> user.id cascade delete), accountId (text not null), providerId (text not null), accessToken (text nullable), refreshToken (text nullable), accessTokenExpiresAt (timestamp nullable), refreshTokenExpiresAt (timestamp nullable), scope (text nullable), idToken (text nullable), password (text nullable), createdAt (timestamp not null defaultNow), updatedAt (timestamp not null defaultNow)
    4. `verification` table: id (text PK), identifier (text not null), value (text not null), expiresAt (timestamp not null), createdAt (timestamp not null defaultNow), updatedAt (timestamp not null defaultNow)

    Define Drizzle relations:
    - `userRelations`: user has many sessions (one-to-many), user has many accounts (one-to-many)
    - `sessionRelations`: session belongs to user (many-to-one via userId)
    - `accountRelations`: account belongs to user (many-to-one via userId)

    Use `drizzle-orm/pg-core` for table definitions and `drizzle-orm` for relations.
    Column names use snake_case in the database (e.g., `email_verified`, `created_at`) but camelCase in TypeScript via the column mapping.

    **Update `backend/src/db/schema/index.ts`:**
    Add `export * from './auth.js'` to barrel export the auth schema.

    **Update `backend/src/config.ts`:**
    Add `baseURL` to the `auth` section:
    ```
    auth: {
      secret: requireEnvMinLength('APP_SECRET', 32),
      baseURL: requireEnv('AUTH_BASE_URL'),
    },
    ```
    This is the public-facing URL including `/api` (e.g., `http://localhost:8100/api`).

    **Update `.env.example`:**
    Add `AUTH_BASE_URL` in the Security section:
    ```
    # Auth base URL (public-facing URL including /api path)
    # Dev: http://localhost:8100/api (set by compose)
    # Prod: https://yourdomain.com/api
    AUTH_BASE_URL=http://localhost:8100/api
    ```

    **Generate migration:**
    Run `npx drizzle-kit generate` from backend/ directory (with env vars loaded) to produce the SQL migration file. The migration should create the four auth tables. Name convention: migrations are auto-numbered by drizzle-kit.
  </action>
  <verify>
    - `npx tsc --noEmit` in backend/ passes
    - `backend/src/db/schema/auth.ts` exports user, session, account, verification tables + relations
    - `backend/src/db/schema/index.ts` re-exports auth schema
    - `backend/src/config.ts` has `auth.baseURL` field
    - `.env.example` includes AUTH_BASE_URL
    - A migration SQL file exists in `backend/migrations/` that creates user, session, account, verification tables
  </verify>
  <done>
    Auth schema tables are defined in Drizzle, exported from the schema barrel, config includes AUTH_BASE_URL, .env.example is updated, and a migration file exists to create the tables.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes in backend/ with no errors
2. `backend/src/db/client.ts` exists and exports standalone `db` and `client`
3. `backend/src/db/index.ts` imports from `./client.js` (not creating its own postgres connection)
4. `backend/src/db/schema/auth.ts` defines 4 tables (user, session, account, verification) with relations
5. `backend/src/config.ts` exports `config.auth.baseURL`
6. `.env.example` includes AUTH_BASE_URL
7. Migration SQL file exists in `backend/migrations/`
</verification>

<success_criteria>
- Standalone Drizzle client can be imported from `backend/src/db/client.ts` without Fastify
- Auth schema matches better-auth requirements (4 tables, proper columns, FK relations)
- Config module validates AUTH_BASE_URL as required
- Migration file is generated and ready to run
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-auth-backend/02-01-SUMMARY.md`
</output>
