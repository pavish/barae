---
phase: 01-dev-environment-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/config.ts
  - backend/src/app.ts
  - backend/src/db/index.ts
  - backend/src/index.ts
  - backend/tsconfig.base.json
  - backend/tsconfig.build.json
  - backend/package.json
  - backend/scripts/migrate.ts
  - shared/auth/.gitkeep
  - shared/github/.gitkeep
autonomous: true

must_haves:
  truths:
    - "Backend config validates env vars at module load time with clear error messages for missing/invalid values"
    - "No file in backend/src/ except config.ts reads process.env"
    - "Config exports are fully typed with no optional/undefined values"
    - "TypeScript is in very strict mode (noUncheckedIndexedAccess + exactOptionalPropertyTypes)"
    - "Migration script runs independently against the database without starting Fastify"
    - "Backend dev logs are human-readable via pino-pretty, production uses JSON"
  artifacts:
    - path: "backend/src/config.ts"
      provides: "Standalone env validation and typed config export"
      contains: "requireEnv"
    - path: "backend/scripts/migrate.ts"
      provides: "Standalone Drizzle migration runner"
      contains: "migrate"
    - path: "shared/auth/.gitkeep"
      provides: "Shared auth types directory placeholder"
    - path: "shared/github/.gitkeep"
      provides: "Shared github types directory placeholder"
  key_links:
    - from: "backend/src/app.ts"
      to: "backend/src/config.ts"
      via: "import { config }"
      pattern: "import.*config.*from.*config"
    - from: "backend/src/db/index.ts"
      to: "backend/src/config.ts"
      via: "import { config }"
      pattern: "import.*config.*from.*config"
    - from: "backend/src/index.ts"
      to: "backend/src/config.ts"
      via: "import { config }"
      pattern: "import.*config.*from.*config"
---

<objective>
Rewrite the backend foundation: replace the @fastify/env config plugin with a standalone config module, update all consumers (app.ts, db/index.ts, index.ts) to use the new config, tighten TypeScript to very strict mode, add pino-pretty for dev logging, create the standalone migration script, and scaffold the shared/ directory.

Purpose: Establish the config-as-single-source-of-truth pattern and backend TypeScript strictness that all future phases build upon.
Output: Working backend code with standalone config, migration script, strict TypeScript, and shared/ directory structure.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/STANDARDS.md
@.planning/phases/01-dev-environment-infrastructure/01-CONTEXT.md
@.planning/phases/01-dev-environment-infrastructure/01-RESEARCH.md
@backend/src/config.ts
@backend/src/app.ts
@backend/src/db/index.ts
@backend/src/index.ts
@backend/tsconfig.base.json
@backend/tsconfig.build.json
@backend/package.json
@backend/drizzle.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite config.ts as standalone module + install pino-pretty</name>
  <files>backend/src/config.ts, backend/package.json</files>
  <action>
  1. Install pino-pretty as a devDependency: `cd backend && npm install -D pino-pretty`

  2. Replace `backend/src/config.ts` entirely. The new config.ts must:
     - Import `process` from `node:process`
     - Define helper functions: `requireEnv(name)`, `optionalEnv(name, default)`, `requireEnvInt(name)`, `optionalEnvInt(name, default)`, `requireEnvMinLength(name, minLength)`
     - Each helper throws a descriptive Error on validation failure (e.g., `Missing required environment variable: POSTGRES_HOST`)
     - Export a single `config` object with these sections:
       ```
       server: { host, port, nodeEnv }
       db: { host, port, database, user, password }
       auth: { secret (minLength 32) }
       smtp: { host, port, user, password, secure, from }
       ```
     - `server.host` = optionalEnv('SERVER_HOST', '0.0.0.0')
     - `server.port` = optionalEnvInt('SERVER_PORT', 3000)
     - `server.nodeEnv` = optionalEnv('NODE_ENV', 'development')
     - All db fields are required via requireEnv/requireEnvInt
     - `auth.secret` = requireEnvMinLength('APP_SECRET', 32)
     - All smtp fields are optional with sensible defaults (empty strings for host/user/password, 587 for port, false for secure, 'Barae <noreply@barae.app>' for from)
     - `smtp.secure` computed as: `optionalEnv('SMTP_SECURE', 'false') === 'true'`
     - Mark the export as `as const`
     - Export the type: `export type Config = typeof config`
     - Do NOT use @fastify/env, TypeBox, fastify-plugin, or any Fastify dependencies
     - Do NOT declare Fastify module augmentation (remove the old `declare module 'fastify'` block)
     - Do NOT include GitHub-specific env vars yet (those come in Phase 4)

  3. Remove `@fastify/env` from backend/package.json dependencies. It is no longer used.
     Run: `cd backend && npm uninstall @fastify/env`
  </action>
  <verify>
  - `cat backend/src/config.ts` shows standalone module with no Fastify imports
  - `grep -r "process\.env" backend/src/ --include="*.ts"` returns ONLY `config.ts` (and nothing else)
  - `grep "@fastify/env" backend/package.json` returns no results
  - `grep "pino-pretty" backend/package.json` shows it in devDependencies
  </verify>
  <done>config.ts is a standalone module exporting typed, validated config. No process.env usage anywhere else in backend/src/. @fastify/env removed. pino-pretty installed.</done>
</task>

<task type="auto">
  <name>Task 2: Update app.ts, db/index.ts, index.ts + TypeScript strictness</name>
  <files>backend/src/app.ts, backend/src/db/index.ts, backend/src/index.ts, backend/tsconfig.base.json, backend/tsconfig.build.json</files>
  <action>
  1. Update `backend/src/app.ts`:
     - Import `{ config }` from `./config.js` (not as a plugin)
     - Remove `import config from './config.js'` (old plugin import)
     - Remove `await app.register(config)` -- config is no longer a Fastify plugin
     - Configure Fastify logger with pino-pretty for dev:
       ```typescript
       const app = fastify({
         logger: {
           level: config.server.nodeEnv === 'production' ? 'info' : 'debug',
           ...(config.server.nodeEnv !== 'production' && {
             transport: {
               target: 'pino-pretty',
               options: {
                 translateTime: 'HH:MM:ss Z',
                 ignore: 'pid,hostname',
               },
             },
           }),
         },
       }).withTypeProvider<TypeBoxTypeProvider>()
       ```
     - Update CORS origin to use a hardcoded default or config value. Since FRONTEND_URL is not in config for Phase 1, use `'*'` in development or remove CORS restriction for now (CORS is not critical behind Caddy). Simplest: remove CORS plugin registration entirely for now -- Caddy handles the requests in both dev and prod, so CORS is not needed. Remove the `@fastify/cors` import and registration.
     - Update health check: `app.db.do` changes to use the db plugin's drizzle instance (this stays the same since db plugin still decorates Fastify)
     - Export `config` re-export from app.ts so index.ts can use it, OR have index.ts import config directly

  2. Update `backend/src/db/index.ts`:
     - Import `{ config }` from `../config.js` instead of reading from `fastify.config`
     - In `createDbHandler`, use `config.db.host`, `config.db.port`, `config.db.database`, `config.db.user`, `config.db.password` instead of `fastify.config.POSTGRES_*`
     - Remove the `dependencies: ['config']` from the plugin options since db no longer depends on the config Fastify plugin
     - Keep the Fastify plugin structure for db (it still decorates the Fastify instance with the db connection)
     - Remove the FastifyInstance parameter from createDbHandler -- it no longer needs Fastify to access config

  3. Update `backend/src/index.ts`:
     - Import `{ config }` from `./config.js`
     - Replace `app.config.SERVER_HOST` with `config.server.host`
     - Replace `app.config.SERVER_PORT` with `config.server.port`
     - The `app.log` calls remain the same (Fastify logger is configured in app.ts)

  4. Update `backend/tsconfig.base.json` to add very strict settings:
     ```json
     {
       "extends": "fastify-tsconfig",
       "compilerOptions": {
         "noUncheckedIndexedAccess": true,
         "exactOptionalPropertyTypes": true,
         "skipLibCheck": true,
         "baseUrl": ".",
         "paths": {
           "@/*": ["./src/*"]
         }
       },
       "include": ["@types", "**/*.ts"]
     }
     ```

  5. Update `backend/tsconfig.build.json` to include path alias resolution. Note: tsx handles path aliases at dev time via tsconfig paths. For the build, tsc doesn't resolve path aliases natively -- but since the codebase currently uses relative imports and will continue to use relative imports for now, the `@/` alias is configured for future use. No changes needed to tsconfig.build.json beyond ensuring it inherits from tsconfig.base.json correctly.

  6. If there are TypeScript errors from the new strict settings, fix them. Common issues:
     - `exactOptionalPropertyTypes` may require `| undefined` on optional properties
     - `noUncheckedIndexedAccess` may require null checks on array/object access

  7. Remove `@fastify/cors` since Caddy handles all proxying (no direct browser-to-backend requests):
     Run: `cd backend && npm uninstall @fastify/cors`
  </action>
  <verify>
  - `cd backend && npx tsc --noEmit` completes with no errors (type checking passes with strict settings)
  - `grep "noUncheckedIndexedAccess" backend/tsconfig.base.json` shows the setting
  - `grep "exactOptionalPropertyTypes" backend/tsconfig.base.json` shows the setting
  - `grep "fastify.config" backend/src/` returns no results (all config access is via imported config module)
  - `grep "@fastify/cors" backend/package.json` returns no results
  </verify>
  <done>app.ts uses standalone config import (not plugin), db/index.ts uses config.db.*, index.ts uses config.server.*, TypeScript is very strict with @/ alias configured, pino-pretty configured for dev logging, CORS removed.</done>
</task>

<task type="auto">
  <name>Task 3: Create migration script + shared/ directory scaffold</name>
  <files>backend/scripts/migrate.ts, backend/package.json, shared/auth/.gitkeep, shared/github/.gitkeep</files>
  <action>
  1. Create `backend/scripts/migrate.ts`:
     - Import `drizzle` from `drizzle-orm/postgres-js`
     - Import `migrate` from `drizzle-orm/postgres-js/migrator`
     - Import `postgres` from `postgres`
     - Read database env vars directly from `process.env` (this script runs independently, NOT through the app config -- it's a standalone script that may run before the app, in CI/CD, or manually). This is the ONE exception to the "no process.env outside config" rule -- migration scripts are deployment tools, not application code.
     - Validate that all required env vars are present (POSTGRES_HOST, POSTGRES_PORT, POSTGRES_DB, POSTGRES_USER, POSTGRES_PASSWORD). If any missing, log error and exit(1).
     - Create postgres client with `max: 1` (critical for migrations)
     - Create drizzle instance
     - Run `migrate(db, { migrationsFolder: './migrations' })` -- path relative to CWD (backend/)
     - Log success/failure messages with console.log/console.error
     - Call `client.end()` in finally block
     - Exit with code 0 on success, 1 on failure

  2. Add script to `backend/package.json`:
     - Update `"db:migrate"` to: `"tsx scripts/migrate.ts"` (replaces drizzle-kit migrate)
     - Keep `"db:generate": "drizzle-kit generate"` unchanged
     - Keep `"db:push": "drizzle-kit push"` unchanged
     - Keep `"db:studio": "drizzle-kit studio"` unchanged
     - Remove the old `"db:migrate:prod": "node dist/db/migrate.js"` script

  3. Create `shared/` directory structure:
     - Create `shared/auth/.gitkeep` (empty file, placeholder for future auth types)
     - Create `shared/github/.gitkeep` (empty file, placeholder for future GitHub types)
     - These directories will be populated in Phase 2 (auth types) and Phase 4 (GitHub types)
  </action>
  <verify>
  - `cat backend/scripts/migrate.ts` shows standalone migration script with `max: 1` and proper env validation
  - `cat backend/package.json | grep db:migrate` shows the new tsx-based migration command
  - `ls shared/auth/.gitkeep shared/github/.gitkeep` both exist
  - `grep "db:migrate:prod" backend/package.json` returns no results (removed)
  </verify>
  <done>Migration script exists at backend/scripts/migrate.ts with single-connection constraint. shared/ directory scaffolded with auth/ and github/ subdirectories. Package.json scripts updated.</done>
</task>

</tasks>

<verification>
1. `cd backend && npx tsc --noEmit` -- TypeScript compiles with no errors under very strict settings
2. `grep -r "process\.env" backend/src/ --include="*.ts"` -- only config.ts
3. `grep -r "@fastify/env" backend/` -- no results
4. `cat backend/src/config.ts` -- standalone module, no Fastify imports
5. `cat backend/scripts/migrate.ts` -- standalone migration script
6. `ls shared/auth/ shared/github/` -- directories exist
</verification>

<success_criteria>
- Backend compiles with `noUncheckedIndexedAccess` and `exactOptionalPropertyTypes` enabled
- Config is a standalone module (not a Fastify plugin) with typed, validated exports
- No process.env usage outside config.ts in backend/src/
- Migration script is a standalone executable (not embedded in app startup)
- shared/ directory exists with domain subdirectories
- pino-pretty configured for dev logging
</success_criteria>

<output>
After completion, create `.planning/phases/01-dev-environment-infrastructure/01-01-SUMMARY.md`
</output>
