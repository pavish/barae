---
phase: 01-dev-environment-infrastructure
plan: 04
type: execute
wave: 4
depends_on: ["01-03"]
files_modified:
  - .planning/codebase/STANDARDS.md
autonomous: false

must_haves:
  truths:
    - "Running docker compose -f compose.dev.yml up starts all 5 services and the app is accessible at localhost:8100"
    - "Navigating to localhost:8100 shows the frontend (Barae placeholder page)"
    - "Navigating to localhost:8100/api/v1/health returns JSON health status from Fastify backend"
    - "Vite HMR works through Caddy proxy (frontend changes reflect without full page reload)"
    - "STANDARDS.md reflects any patterns discovered during implementation"
  artifacts:
    - path: ".planning/codebase/STANDARDS.md"
      provides: "Updated codebase standards with implementation-discovered patterns"
      contains: "Priority Rules"
  key_links:
    - from: "localhost:8100"
      to: "caddy/Caddyfile.dev"
      via: "Caddy listening on port 8100"
      pattern: ":8100"
    - from: "localhost:8100/api/*"
      to: "backend:3000"
      via: "Caddy handle_path strips /api/ and proxies"
      pattern: "handle_path /api/\\*"
---

<objective>
Verify the complete dev stack works end-to-end and update STANDARDS.md with any patterns discovered during implementation of Plans 01-03.

Purpose: Ensure the Phase 1 goal is met -- the development environment is fully operational.
Output: Verified working dev stack, updated STANDARDS.md.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/STANDARDS.md
@.planning/phases/01-dev-environment-infrastructure/01-01-SUMMARY.md
@.planning/phases/01-dev-environment-infrastructure/01-02-SUMMARY.md
@.planning/phases/01-dev-environment-infrastructure/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update STANDARDS.md with implementation patterns</name>
  <files>.planning/codebase/STANDARDS.md</files>
  <action>
  Review the SUMMARYs from Plans 01, 02, and 03. If any implementation patterns were discovered that aren't already in STANDARDS.md, add them. Typical additions:

  1. Add to Priority Rules if any new critical rules emerged during implementation
  2. Add any clarifications needed based on implementation experience, such as:
     - Exception: `drizzle.config.ts` and `scripts/migrate.ts` may read `process.env` directly (they are CLI/deployment tools, not application code)
     - Caddy handles CORS in dev/prod (no @fastify/cors needed)
     - Import alias: `@/` maps to `src/` in both backend and frontend
  3. Add Docker patterns section if not already covered:
     - Dev compose: 5 services (db, mailpit, backend, frontend, proxy)
     - Build context: always project root (.)
     - Backend accessible only through Caddy proxy (no direct port exposure in dev)
  4. Add logging pattern:
     - pino-pretty for dev, JSON for production
     - Configured in app.ts via Fastify logger options

  Keep the document concise -- patterns only, no implementation details.
  Do NOT add anything that duplicates what's already there.
  </action>
  <verify>
  - `cat .planning/codebase/STANDARDS.md` -- updated with new patterns
  - No duplicate entries
  </verify>
  <done>STANDARDS.md updated with patterns discovered during Phase 1 implementation.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify dev stack works end-to-end</name>
  <what-built>Complete development environment: Docker Compose with Caddy proxy, Fastify backend, Vite frontend, PostgreSQL, and Mailpit -- all accessible through localhost:8100.</what-built>
  <how-to-verify>
  1. Start the dev stack:
     ```bash
     docker compose -f compose.dev.yml up --build
     ```
  2. Wait for all containers to be healthy (check `docker compose -f compose.dev.yml ps`)
  3. Open http://localhost:8100 in a browser -- should show the Barae frontend placeholder page
  4. Open http://localhost:8100/api/health in a browser -- should return JSON: `{"status":"ok","timestamp":"..."}`
  5. Check that backend logs are human-readable (pino-pretty formatted, not raw JSON)
  6. (Optional) Edit a frontend file and verify Vite HMR updates the browser without full reload
  7. (Optional) Check Mailpit at http://localhost:8025
  8. Verify database is accessible: `docker compose -f compose.dev.yml exec db psql -U barae -d barae -c "SELECT 1"`
  9. Run migrations: `docker compose -f compose.dev.yml exec backend npx tsx scripts/migrate.ts`

  **Expected results:**
  - Frontend loads at :8100 (through Caddy proxy)
  - API health endpoint responds through Caddy (prefix stripped)
  - Database connection works
  - Migration script runs successfully (even if no migrations exist yet)
  - All 5 containers running: barae-dev-db, barae-dev-mailpit, barae-dev-backend, barae-dev-frontend, barae-dev-proxy
  </how-to-verify>
  <resume-signal>Type "approved" if the dev stack works, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
1. All 5 dev containers are running and healthy
2. Frontend accessible at localhost:8100
3. Backend API accessible at localhost:8100/api/health (JSON response)
4. Database queryable
5. Migration script executable
6. STANDARDS.md updated
</verification>

<success_criteria>
- The development environment is fully operational: docker compose up starts everything, accessible at localhost:8100
- Caddy correctly proxies frontend and API requests
- Backend logs are human-readable in dev
- Migration script runs successfully
- STANDARDS.md reflects the current state of the codebase
</success_criteria>

<output>
After completion, create `.planning/phases/01-dev-environment-infrastructure/01-04-SUMMARY.md`
</output>
